<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-09-24 Mon 13:36 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Influence of Vegetation on Energy Use of Madison WI</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Tedward Erker" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Influence of Vegetation on Energy Use of Madison WI</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb3a3c21">1. Building Energy and Trees</a>
<ul>
<li><a href="#org89535a6">1.1. libraries</a></li>
<li><a href="#org4d5762e">1.2. functions</a></li>
<li><a href="#org106c2b7">1.3. inputs</a></li>
<li><a href="#org38526ab">1.4. Load and join datasets</a>
<ul>
<li><a href="#orgd7c4bda">1.4.1. MGE energy use</a></li>
<li><a href="#org902bc53">1.4.2. Assessors Property</a></li>
<li><a href="#org329ca41">1.4.3. Join Energy with Assessors Property Info</a></li>
<li><a href="#org79a0399">1.4.4. parcels</a></li>
<li><a href="#org2733bf0">1.4.5. Building Footprints</a></li>
<li><a href="#org6d3e059">1.4.6. Mask Building Footprints to the area for which I have parcel information (city of Madison)</a></li>
<li><a href="#org1c68149">1.4.7. crop building footprints to those inside parcels</a></li>
<li><a href="#orgac7ff29">1.4.8. make regions around each building</a></li>
<li><a href="#org9b8f46a">1.4.9. fix colnames</a></li>
<li><a href="#orgba7005b">1.4.10. save regions around buildings</a></li>
</ul>
</li>
<li><a href="#org9d5ecfb">1.5. read in regions around buildings</a></li>
<li><a href="#org716e22f">1.6. Urban Tree Canopy Map</a></li>
<li><a href="#org200525e">1.7. Calculate Tree Cover within regions around each residential building</a>
<ul>
<li><a href="#orgb3a2e72">1.7.1. spread to make a row for each building, rather than a row for each region</a></li>
</ul>
</li>
<li><a href="#org7a017b4">1.8. Join Tree cover to buildings</a></li>
<li><a href="#org6bd74ce">1.9. Calculate Building Cover within regions around each residential building  There could be an error here which is causing me to lose some houses</a>
<ul>
<li><a href="#orgbe80199">1.9.1. load shapefiles</a></li>
<li><a href="#org3067914">1.9.2. split building regions into 5000 chuncks (sent to krusty)</a></li>
<li><a href="#org16b0541">1.9.3. get area of poiygons within another polygon</a></li>
<li><a href="#orgffa1aea">1.9.4. save out</a></li>
</ul>
</li>
<li><a href="#orgc9cd6c3">1.10. Join Building Cover to Buildings</a></li>
<li><a href="#org33ca352">1.11. Model</a>
<ul>
<li><a href="#orgbc4133e">1.11.1. full df</a></li>
<li><a href="#orgc04b992">1.11.2. PCA of building covariates</a></li>
<li><a href="#org7caa606">1.11.3. remove useless variables</a></li>
<li><a href="#org21413bc">1.11.4. remove a few more not useful covariates</a></li>
<li><a href="#orga251665">1.11.5. rescale tree and building area divide by 100</a></li>
<li><a href="#org6c83a5e">1.11.6. Fit Models</a></li>
</ul>
</li>
<li><a href="#org88b49f1">1.12. Plot Coefficients from all models</a></li>
<li><a href="#org18e29b5">1.13. plot median effect of trees maybe make this one spatial (show house in center)</a></li>
<li><a href="#orgc604436">1.14. effect on median house</a>
<ul>
<li><a href="#org8793f96">1.14.1. median tree cover</a></li>
<li><a href="#org8e25ff3">1.14.2. elec</a></li>
<li><a href="#orgfbb188a">1.14.3. gas</a></li>
<li><a href="#org2ce96a7">1.14.4. gas and elec</a></li>
</ul>
</li>
<li><a href="#orgff0bef3">1.15. Comparing C emissions from energy use due to trees to C stored and sequestered.</a>
<ul>
<li><a href="#org9339eee">1.15.1. Consider a green ash tree that grows at .61 cm per year.</a></li>
</ul>
</li>
<li><a href="#orgf2e5f2a">1.16. tree distributions</a></li>
</ul>
</li>
<li><a href="#org8e2898f">2. extending old papers</a>
<ul>
<li><a href="#org22d63f6">2.1. extending cite:thayer_maeda_1985</a></li>
<li><a href="#org1fe1a04">2.2. extending cite:mcpherson_e_1988</a>
<ul>
<li><a href="#org1624999">2.2.1. Libraries</a></li>
<li><a href="#org334db03">2.2.2. costs and carbon emission rates</a></li>
<li><a href="#orgce68412">2.2.3. Figure 3. solar irradiance.</a></li>
<li><a href="#org6043b80">2.2.4. figure 4, wind</a></li>
<li><a href="#org7a09635">2.2.5. combine shade with wind for what they describe as tree conditions.</a></li>
<li><a href="#orgeaaa269">2.2.6. HDD and CDD space</a></li>
</ul>
</li>
<li><a href="#org3744436">2.3. extending cite:huang_e_1990</a>
<ul>
<li><a href="#org12bd97e">2.3.1. Is the effect of wind stronger on heating than cooling? like cite:simpson_mcpherson_1996 claim?</a></li>
</ul>
</li>
<li><a href="#orgb0ccd60">2.4. extending cite:mcpherson_simpson_99</a>
<ul>
<li><a href="#orgca1e9c5">2.4.1. Table 107, shade effects of trees in different regions using default distribution</a></li>
<li><a href="#orge3a60b0">2.4.2. Table 109 - climate effects of trees, (evapotranspiration and wind)</a></li>
</ul>
</li>
<li><a href="#org8d6f60f">2.5. extending cite:akbari_konopacki_2003,akbari_konopacki_2005</a>
<ul>
<li><a href="#org1b37049">2.5.1. data needed</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org12c78aa">3. compare 2015-04 &#x2013;2016-04 to climate normals</a></li>
</ul>
</div>
</div>
<p>
##+PROPERTY: header-args:R :session <b>R:energy:krusty</b> :cache no :results output :exports both :tangle no
</p>
<hr />
<div id="outline-container-orgb3a3c21" class="outline-2">
<h2 id="orgb3a3c21"><span class="section-number-2">1</span> Building Energy and Trees</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org89535a6" class="outline-3">
<h3 id="org89535a6"><span class="section-number-3">1.1</span> libraries</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">library</span>(plyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(ascii)
<span style="color: #268bd2; font-weight: bold;">library</span>(broom)
<span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(stringr)
<span style="color: #268bd2; font-weight: bold;">library</span>(raster)
<span style="color: #268bd2; font-weight: bold;">library</span>(rgeos)
<span style="color: #268bd2; font-weight: bold;">library</span>(rgdal)
<span style="color: #268bd2; font-weight: bold;">library</span>(foreach)
<span style="color: #268bd2; font-weight: bold;">library</span>(doParallel)
<span style="color: #268bd2; font-weight: bold;">library</span>(ggplot2)
<span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(GGally)
<span style="color: #268bd2; font-weight: bold;">library</span>(maptools)
</pre>
</div>

<pre class="example">

Attaching package: ‘tidyr’

The following object is masked from ‘package:ascii’:

    expand
Loading required package: sp

Attaching package: ‘raster’

The following object is masked from ‘package:tidyr’:

    extract
rgeos version: 0.3-26, (SVN revision 560)
 GEOS runtime version: 3.6.1-CAPI-1.10.1 r0
 Linking to sp version: 1.2-5
 Polygon checking: TRUE
rgdal: version: 1.2-18, (SVN revision 718)
 Geospatial Data Abstraction Library extensions to R successfully loaded
 Loaded GDAL runtime: GDAL 2.1.3, released 2017/20/01
 Path to GDAL shared files: /Library/Frameworks/R.framework/Versions/3.4/Resources/library/rgdal/gdal
 GDAL binary built with GEOS: FALSE
 Loaded PROJ.4 runtime: Rel. 4.9.3, 15 August 2016, [PJ_VERSION: 493]
 Path to PROJ.4 shared files: /Library/Frameworks/R.framework/Versions/3.4/Resources/library/rgdal/proj
 Linking to sp version: 1.2-7
Warning message:
package ‘rgdal’ was built under R version 3.4.4
foreach: simple, scalable parallel programming from Revolution Analytics
Use Revolution R for scalability, fault tolerance and more.
http://www.revolutionanalytics.com
Loading required package: iterators
Loading required package: parallel

Attaching package: ‘dplyr’

The following objects are masked from ‘package:rgeos’:

    intersect, setdiff, union

The following objects are masked from ‘package:raster’:

    intersect, select, union

The following objects are masked from ‘package:plyr’:

    arrange, count, desc, failwith, id, mutate, rename, summarise,
    summarize

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

Attaching package: ‘GGally’

The following object is masked from ‘package:dplyr’:

    nasa

Warning message:
package ‘GGally’ was built under R version 3.4.4
Checking rgeos availability: TRUE
</pre>
</div>
</div>

<div id="outline-container-org4d5762e" class="outline-3">
<h3 id="org4d5762e"><span class="section-number-3">1.2</span> functions</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<ol class="org-ol">
<li><a id="orgb162160"></a>Convert kWh to Carbon kg<br />
<div class="outline-text-5" id="text-1-2-0-1">
<p>
<a href="https://www.epa.gov/sites/production/files/2015-10/documents/egrid2012_ghgoutputrates_0.pdf">https://www.epa.gov/sites/production/files/2015-10/documents/egrid2012_ghgoutputrates_0.pdf</a>
<a href="https://www.epa.gov/energy/emissions-generation-resource-integrated-database-egrid">https://www.epa.gov/energy/emissions-generation-resource-integrated-database-egrid</a>
<a href="https://www.epa.gov/sites/production/files/2017-02/documents/egrid2014_technicalsupportdocument_v2.pdf">https://www.epa.gov/sites/production/files/2017-02/documents/egrid2014_technicalsupportdocument_v2.pdf</a>
</p>

<p>
for electricity made in region MRO East
old (2012?)
1267.5 lbs/MWh * 1kg /2.20462 lb * 1 MWh / 1000 kWh * 12 C /44 CO2
new (2016)
1668.212 * 1kg /2.20462 lb * 1 MWh / 1000 kWh * 12 C /44 CO2
</p>

<div class="org-src-container">
<pre class="src src-R">                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">old 1267.5 / 2.20462 / 1000 *12 /44</span>
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">2016</span>
CperkWh2016 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1668.212 / 2.20462 / 1000 *12 /44
CperkWh2016
</pre>
</div>

<pre class="example">
[1] 0.2063698

</pre>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2;">kWh2kgC</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(kWh) {
    kWh * .2063698
}
</pre>
</div>
</div>
</li>

<li><a id="org0c1d2ff"></a>Convert Therm to Carbon kg<br />
<div class="outline-text-5" id="text-1-2-0-2">
<p>
see <a href="https://www.epa.gov/energy/greenhouse-gases-equivalencies-calculator-calculations-and-references">https://www.epa.gov/energy/greenhouse-gases-equivalencies-calculator-calculations-and-references</a>
0.1 mmbtu/1 therm × 14.46 kg C/mmbtu
</p>

<div class="org-src-container">
<pre class="src src-R">.1*14.46
</pre>
</div>

<pre class="example">
[1] 1.446

</pre>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2;">therm2kgC</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(therms) {
    therms * 1.446
}
</pre>
</div>
</div>
</li>
<li><a id="orge82118d"></a>define extract polygons parallel function<br />
<div class="outline-text-5" id="text-1-2-0-3">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2;">extract.polygons.parallel</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(x, sp.polygons, cores) {

    n <span style="color: #268bd2; font-weight: bold;">&lt;-</span> ceiling(length(sp.polygons) / cores)
    v <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1:length(sp.polygons)
    l <span style="color: #268bd2; font-weight: bold;">&lt;-</span> split(v, ceiling(seq_along(v)/n))

    cl <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeCluster(cores)
    registerDoParallel(cl)

    out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> foreach(i = seq_along(l), .packages = <span style="color: #2aa198;">"raster"</span>) <span style="color: #268bd2; font-weight: bold;">%dopar%</span> {
        sp.sub <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sp.polygons[l[[i]],]
        raster::extract(x, sp.sub)
    }
    closeAllConnections()

    <span style="color: #859900; font-weight: bold;">return</span>(out)
}

</pre>
</div>
</div>
</li>

<li><a id="orgc68c43e"></a>other and make regions around polygons<br />
<div class="outline-text-5" id="text-1-2-0-4">
<div class="org-src-container">
<pre class="src src-R">
options(asciiType = <span style="color: #2aa198;">"org"</span>)
<span style="color: #268bd2;">ascii.nowarn.print</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(x,...) {
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">op &lt;- options(warn = -1)</span>
                                        <span style="color: #93a1a1;">#      </span><span style="color: #93a1a1;">on.exit(options(op))</span>

    suppressWarnings(print(ascii(x,...)))

}


</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">
poly <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readWKT(<span style="color: #2aa198;">"POLYGON ((78.6 41.7, 91.3 41.7, 91.3 26.6, 78.7 26.6, 78.6 41.7))"</span>)

poly <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as(poly, <span style="color: #2aa198;">"SpatialPolygonsDataFrame"</span>)
poly@data$BUILDINGFO = 0


poly <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.res.primary.parcels[27940,]
buffer.widths <span style="color: #268bd2; font-weight: bold;">&lt;-</span> seq(0,51,3)
out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeRegionsAroundPolygonManyAngles(poly, buffer.widths)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">angles are 1% different than sunrize sunset azimuth angles of solstaces</span>
                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">57</span>
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">123</span>
<span style="color: #268bd2;">makeRegionsAroundPolygonManyAngles</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(poly) {

    theta = c(57,123)
    buffer.widths <span style="color: #268bd2; font-weight: bold;">&lt;-</span> seq(0,60,20)

    bc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> gCentroid(poly)
    bcb <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sapply(buffer.widths, <span style="color: #859900; font-weight: bold;">function</span>(w) gBuffer(poly, width = w, byid = T))
    bcbd <span style="color: #268bd2; font-weight: bold;">&lt;-</span> list(gDifference(bcb[[4]], bcb[[2]]), bcb[[2]])
    bcb <span style="color: #268bd2; font-weight: bold;">&lt;-</span> do.call(bind, bcbd)

    theta.radians <span style="color: #268bd2; font-weight: bold;">&lt;-</span> (theta + 90)*pi/180  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">add 90 to make the 0 degrees be north</span>
    r <span style="color: #268bd2; font-weight: bold;">&lt;-</span> max(buffer.widths) + sqrt(gArea(poly)/pi) * 3

    y <span style="color: #268bd2; font-weight: bold;">&lt;-</span> r*sin(theta.radians)
    x <span style="color: #268bd2; font-weight: bold;">&lt;-</span> r*cos(theta.radians)

    x1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> coordinates(bc)[,1 ] + x
    y1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> coordinates(bc)[,2] + y

    x2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> coordinates(bc)[,1 ] - x
    y2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> coordinates(bc)[,2] - y

    line = SpatialLines(list(Lines(list(Line(cbind(c(x1,x2),c(y1,y2)))), ID=<span style="color: #2aa198;">"line"</span>)))

    line = SpatialLines(sapply(1:length(x1), <span style="color: #859900; font-weight: bold;">function</span>(i) list(Lines(Line(cbind(c(x1[i],x2[i]),c(y1[i],y2[i]))), ID=i))))
    proj4string(line) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> crs(poly)


    o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lapply(1:length(bcb), <span style="color: #859900; font-weight: bold;">function</span>(i) {
        lpi <span style="color: #268bd2; font-weight: bold;">&lt;-</span> gIntersection(bcb[i,], line)
        blpi <span style="color: #268bd2; font-weight: bold;">&lt;-</span> gBuffer(lpi, width = 0.001)  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">create a very thin polygon buffer of the intersected line</span>
        dpi <span style="color: #268bd2; font-weight: bold;">&lt;-</span> gDifference(bcb[i,], blpi)              <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">split using gDifference</span>
        disaggregate(dpi)
    })

    o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> do.call(bind, o)


    dist <span style="color: #268bd2; font-weight: bold;">&lt;-</span> gDistance(poly, o, byid = T)
    dist <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sapply(dist, <span style="color: #859900; font-weight: bold;">function</span>(d) buffer.widths[which(abs(buffer.widths - d) == min(abs(buffer.widths - d)))])


                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">add to the distance the difference between widths so that the distance is the cover less than a certain distance away.</span>
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">It will make things make more sense later on.  something like dist +3.  or dist + .. something like: buffer.widths - lag(buffer.widths)</span>


    direction <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sapply(1:length(o), <span style="color: #859900; font-weight: bold;">function</span>(i) {
        diff.coords <span style="color: #268bd2; font-weight: bold;">&lt;-</span> coordinates(bc) - coordinates(gCentroid(o[i,]))
        atan2(diff.coords[1], diff.coords[2]) * 180/pi + 180 <span style="color: #268bd2; font-weight: bold;">%%</span> 360 <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">get rid of negative angles, but on 0-360 scale</span>
    })

    angles <span style="color: #268bd2; font-weight: bold;">&lt;-</span> seq(0,360,90)

    closest.angles <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sapply(direction, <span style="color: #859900; font-weight: bold;">function</span>(dir) which(abs(angles - dir) == min(abs(angles - dir))))

    direction <span style="color: #268bd2; font-weight: bold;">&lt;-</span> angles[closest.angles]
    direction[direction &gt;= 360] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0

    direction <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as.character(direction)

    o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> SpatialPolygonsDataFrame(o, data = data.frame(BUILDINGFO = poly@data$BUILDINGFO,
                                                       distance.from.building = dist,
                                                       direction = direction))

    o
}
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org106c2b7" class="outline-3">
<h3 id="org106c2b7"><span class="section-number-3">1.3</span> inputs</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-R">build.shapefile.path <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"../RD/dane_cty_building_footprint_2010/BuildingFootprint.shp"</span>
parcels.shapefile.path <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"../RD/dane_cty_parcels_2014/Dane_Parcels_2014.shp"</span>
energy.data.frame.path <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"../RD/energy.dataframe-2016-04-12-15-40-59.rds"</span>
assessors.property.path <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"../RD/Assessor_Property_Information.csv"</span>
mad.utc.path <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"../RD/madison_utc/3_ClassifiedUrbanArea.tif"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org38526ab" class="outline-3">
<h3 id="org38526ab"><span class="section-number-3">1.4</span> Load and join datasets</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-orgd7c4bda" class="outline-4">
<h4 id="orgd7c4bda"><span class="section-number-4">1.4.1</span> MGE energy use</h4>
<div class="outline-text-4" id="text-1-4-1">

<div class="figure">
<p><img src="file:///Users/erker/projects/energy/figs/MGE_screenshot_ChancellorsHouse.png" alt="MGE_screenshot_ChancellorsHouse.png" />
</p>
</div>

<p>
<a href="https://www.mge.com/customer-service/home/average-use-cost/results.htm?hn=130&amp;sd=N&amp;sn=Prospect&amp;ss=Av&amp;au=2&amp;c=Madison">https://www.mge.com/customer-service/home/average-use-cost/results.htm?hn=130&amp;sd=N&amp;sn=Prospect&amp;ss=Av&amp;au=2&amp;c=Madison</a>
</p>
<div class="org-src-container">
<pre class="src src-R">energy <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(energy.data.frame.path)
</pre>
</div>
</div>
</div>
<div id="outline-container-org902bc53" class="outline-4">
<h4 id="org902bc53"><span class="section-number-4">1.4.2</span> Assessors Property</h4>
<div class="outline-text-4" id="text-1-4-2">

<div class="figure">
<p><img src="file:///Users/erker/projects/energy/figs/AssessorsPropertyDataScreenShot.png" alt="AssessorsPropertyDataScreenShot.png" width="900" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">ass.prop <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(assessors.property.path, stringsAsFactors = F)
</pre>
</div>
</div>
</div>

<div id="outline-container-org329ca41" class="outline-4">
<h4 id="org329ca41"><span class="section-number-4">1.4.3</span> Join Energy with Assessors Property Info</h4>
<div class="outline-text-4" id="text-1-4-3">
<div class="org-src-container">
<pre class="src src-R">ass.prop.energy <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(energy, ass.prop) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(PropertyAd = toupper(Address))
</pre>
</div>

<pre class="example">
Joining, by = "Parcel"

</pre>
</div>
</div>

<div id="outline-container-org79a0399" class="outline-4">
<h4 id="org79a0399"><span class="section-number-4">1.4.4</span> parcels</h4>
<div class="outline-text-4" id="text-1-4-4">

<div class="figure">
<p><img src="../figs/Screenshot 2017-10-10 12.56.46.png" alt="Screenshot 2017-10-10 12.56.46.png" width="900" />
</p>
</div>
<div class="org-src-container">
<pre class="src src-R">parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(parcels.shapefile.path)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">parcels.energy <span style="color: #268bd2; font-weight: bold;">&lt;-</span> subset(parcels, PropertyAd <span style="color: #268bd2; font-weight: bold;">%in%</span> ass.prop.energy$PropertyAd)

parcels.energy@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(parcels.energy@data, ass.prop.energy, by = c(<span style="color: #2aa198;">"PropertyAd"</span>))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">parcels.energy <span style="color: #268bd2; font-weight: bold;">&lt;-</span> subset(parcels.energy, complete.cases(kWh_High) &amp; kWh_High &gt;0)


parcels.energy@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> parcels.energy@data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    dplyr::select(Parcel,
                  Address,
                  kWh_High,
                  kWh_Mon_Avg_last12mo,
                  Cost_kWh_High,
                  Cost_kWh_Avg,
                  Therms_High,
                  Therms_Mon_Avg_last12mo,
                  Cost_Therms_High,
                  Cost_Therms_Avg,
                  Electric_for_Heating,
                  Current.Year.Land.Value,
                  Current.Year.Improvement.Value,
                  Lot.Size.Sq.Ft,
                  Water.Frontage,
                  Elementary.School,
                  Middle.School,
                  High.School,
                  Ward,
                  State.Assembly.District,
                  Home.Style,
                  Year.Built,
                  Stories,
                  Dwelling.Units,
                  Bedrooms,
                  Full.Baths,
                  Half.Baths,
                  Fireplaces,
                  Central.Air,
                  First.Floor.Living.Area,
                  Second.Floor.Living.Area,
                  Third.Floor.Living.Area,
                  Above.Third.Floor.Living.Area,
                  Total.Living.Area,
                  Finished.Attic,
                  Finished.Basement,
                  Total.Basement,
                  Crawl.Space,
                  Exterior.Wall.1,
                  Exterior.Wall.2,
                  Foundation,
                  Roof,
                  Roof.Replaced.Year,
                  Garage.1,
                  Garage.Stalls.1,
                  Garage2,
                  Garage.Stalls.2,
                  Driveway) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(Electric_for_Heating = factor(Electric_for_Heating),
           Water.Frontage = factor(Water.Frontage),
           Elementary.School = factor(Elementary.School),
           Middle.School = factor(Middle.School),
           High.School = factor(High.School),
           Ward = factor(Ward),
           State.Assembly.District = factor(State.Assembly.District),
           Home.Style = factor(Home.Style),
           Central.Air = factor(Central.Air),
           Exterior.Wall.1 = factor(Exterior.Wall.1),
           Exterior.Wall.2 = factor(Exterior.Wall.2),
           Foundation = factor(Foundation),
           Roof = factor(Roof),
           Garage.1 = factor(Garage.1),
           Garage2 = factor(Garage2),
           Driveway = factor(Driveway)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(Current.Year.Improvement.Value.th = as.numeric(str_replace(Current.Year.Improvement.Value,<span style="color: #2aa198;">"\\$"</span>,<span style="color: #2aa198;">""</span>))/1000,
           Current.Year.Land.Value.th = as.numeric(str_replace(Current.Year.Land.Value,<span style="color: #2aa198;">"\\$"</span>,<span style="color: #2aa198;">""</span>))/1000) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    dplyr::select(-Current.Year.Improvement.Value, -Current.Year.Land.Value)

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">writeOGR(parcels.energy, dsn = <span style="color: #2aa198;">"../DD/"</span>, layer = <span style="color: #2aa198;">"parcels.energy.propinfo"</span>, driver = <span style="color: #2aa198;">"ESRI Shapefile"</span>, overwrite = T)
saveRDS(colnames(parcels.energy@data), <span style="color: #2aa198;">"../DD/colnames.parcels.energy.propinfo.rds"</span>)
saveRDS(parcels.energy$Parcel, <span style="color: #2aa198;">"../DD/parcelID.parcels.energy.propinfo.rds"</span>)
</pre>
</div>

<pre class="example">
Warning message:
In writeOGR(parcels.energy, dsn = "../DD/", layer = "parcels.energy.propinfo",  :
  Field names abbreviated for ESRI Shapefile driver

</pre>

<div class="org-src-container">
<pre class="src src-R">parcels.energy <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/parcels.energy.propinfo.shp"</span>)
parcels.energy$Parcel <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(<span style="color: #2aa198;">"../DD/parcelID.parcels.energy.propinfo.rds"</span>)
colnames(parcels.energy@data) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(<span style="color: #2aa198;">"../DD/colnames.parcels.energy.propinfo.rds"</span>)
parcels.energy <span style="color: #268bd2; font-weight: bold;">&lt;-</span> spTransform(parcels.energy, crs(<span style="color: #2aa198;">"+init=epsg:32616"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2733bf0" class="outline-4">
<h4 id="org2733bf0"><span class="section-number-4">1.4.5</span> Building Footprints</h4>
<div class="outline-text-4" id="text-1-4-5">

<div class="figure">
<p><img src="../figs/Screenshot 2017-10-10 13.08.15.png" alt="Screenshot 2017-10-10 13.08.15.png" width="900" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">build <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(build.shapefile.path)
build.res <span style="color: #268bd2; font-weight: bold;">&lt;-</span> subset(build, BuildingUs == <span style="color: #2aa198;">"Residential"</span>)
build.res.primary <span style="color: #268bd2; font-weight: bold;">&lt;-</span> subset(build.res, BuildingCl == <span style="color: #2aa198;">"Primary"</span>)
build.res.primary <span style="color: #268bd2; font-weight: bold;">&lt;-</span> spTransform(build.res.primary, crs(<span style="color: #2aa198;">"+init=epsg:32616"</span>))
writeOGR(build.res.primary, dsn = <span style="color: #2aa198;">"../DD/"</span>, layer = <span style="color: #2aa198;">"buildings_residential_primary"</span>, driver = <span style="color: #2aa198;">"ESRI Shapefile"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">build.res.primary <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/buildings_residential_primary.shp"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d3e059" class="outline-4">
<h4 id="org6d3e059"><span class="section-number-4">1.4.6</span> Mask Building Footprints to the area for which I have parcel information (city of Madison)</h4>
<div class="outline-text-4" id="text-1-4-6">
<p>
currently footprints cover dane county
</p>
<div class="org-src-container">
<pre class="src src-R">

e <span style="color: #268bd2; font-weight: bold;">&lt;-</span> new(<span style="color: #2aa198;">"Extent"</span>
       , xmin = 294022.535226926
       , xmax = 317479.19202743
       , ymin = 4763205.41481759
       , ymax = 4781697.04891745
         )

e.parcels.energy <span style="color: #268bd2; font-weight: bold;">&lt;-</span> crop(parcels.energy, e)

<span style="color: #268bd2; font-weight: bold;">library</span>(alphahull)
<span style="color: #268bd2; font-weight: bold;">library</span>(igraph)

g <span style="color: #268bd2; font-weight: bold;">&lt;-</span> geom(e.parcels.energy)
i <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sample(1:nrow(g), 20000)

a <span style="color: #268bd2; font-weight: bold;">&lt;-</span> ashape(unique(g[i,5:6]), alpha = 2000)

ag = graph.edgelist(cbind(as.character(a$edges[, <span style="color: #2aa198;">"ind1"</span>]), as.character(a$edges[,
                                                                                <span style="color: #2aa198;">"ind2"</span>])), directed = <span style="color: #b58900;">FALSE</span>)
plot(ag)

<span style="color: #859900; font-weight: bold;">if</span> (!is.connected(ag)) {
    <span style="color: #859900; font-weight: bold;">stop</span>(<span style="color: #2aa198;">"Graph not connected"</span>)
}
<span style="color: #859900; font-weight: bold;">if</span> (any(degree(ag) != 2)) {
    <span style="color: #859900; font-weight: bold;">stop</span>(<span style="color: #2aa198;">"Graph not circular"</span>)
}
<span style="color: #859900; font-weight: bold;">if</span> (clusters(ag)$no &gt; 1) {
    <span style="color: #859900; font-weight: bold;">stop</span>(<span style="color: #2aa198;">"Graph composed of more than one circle"</span>)
}

cutg = ag - E(ag)[1]
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">find chain end points</span>
ends = names(which(degree(cutg) == 1))
path = get.shortest.paths(cutg, ends[1], ends[2])[[1]]
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">this is an index into the points</span>
pathX = as.numeric(V(ag)[path[[1]]]$name)
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">join the ends</span>
pathX = c(pathX, pathX[1])
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">now show the alpha shape plot with our poly on top</span>
plot(a, lwd = 10, col = <span style="color: #2aa198;">"gray"</span>)
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">get the points from the ashape object</span>
lines(a$x[pathX, ], lwd = 2)


a.sp <span style="color: #268bd2; font-weight: bold;">&lt;-</span> SpatialPolygonsDataFrame(SpatialPolygons(list(Polygons(list(Polygon(a$x[pathX,])),1))), data = data.frame(d = 1))

a.sp.buf <span style="color: #268bd2; font-weight: bold;">&lt;-</span> gBuffer(a.sp, width = 100)

build.res.primary.crp <span style="color: #268bd2; font-weight: bold;">&lt;-</span> crop(build.res.primary, a.sp.buf)

writeOGR(build.res.primary.crp, dsn = <span style="color: #2aa198;">"../DD/"</span>, layer = <span style="color: #2aa198;">"buildings_residential_primary_crp2Mad"</span>, driver = <span style="color: #2aa198;">"ESRI Shapefile"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">build.res.primary.crp <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/buildings_residential_primary_crp2Mad.shp"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c68149" class="outline-4">
<h4 id="org1c68149"><span class="section-number-4">1.4.7</span> crop building footprints to those inside parcels</h4>
<div class="outline-text-4" id="text-1-4-7">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2;">parallel.crop</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(sp1,sp2, cores) {
    a <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1:length(sp1)
    a.s <span style="color: #268bd2; font-weight: bold;">&lt;-</span> split(a, rep(1:cores,each = ceiling(length(a)/cores)))

    cl <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeCluster(cores)
    registerDoParallel(cl)

    out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> foreach(i = a.s, .packages = c(<span style="color: #2aa198;">"sp"</span>,<span style="color: #2aa198;">"raster"</span>)) <span style="color: #268bd2; font-weight: bold;">%dopar%</span> {
        o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> crop(sp1[i,], sp2)
    }
    closeAllConnections()
    <span style="color: #859900; font-weight: bold;">return</span>(out)
}

out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> parallel.crop(build.res.primary.crp, parcels.energy, 40)

build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> do.call(<span style="color: #2aa198;">"rbind"</span>,out[sapply(out, FUN = <span style="color: #859900; font-weight: bold;">function</span>(o) !is.null(o))])

build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> spTransform(build.res.primary.parcels, crs(<span style="color: #2aa198;">"+init=epsg:32616"</span>))

                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">remove the fragments of buildings</span>
o.area <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data.frame(id = build.res.primary.crp@data$BUILDINGFO, o.area = gArea(build.res.primary.crp, byid = T))
n.area <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data.frame(id = build.res.primary.parcels@data$BUILDINGFO, n.area =gArea(build.res.primary.parcels, byid = T))

compare.area <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(n.area, o.area) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(area.ratio = n.area / o.area,
           keep = area.ratio &gt; .6)

build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.res.primary.parcels[compare.area$keep,]





df  <span style="color: #268bd2; font-weight: bold;">&lt;-</span> over(build.res.primary.parcels, parcels.energy)
build.res.primary.parcels@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cbind(build.res.primary.parcels@data, df)


                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">If there are two buildings in a parcel, remove the smaller of the two</span>

parcels.w2buidings <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.res.primary.parcels@data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(Parcel) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    summarize(n = n()) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(n &gt; 1) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    pull(Parcel)

build.to.remove <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.res.primary.parcels@data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(Parcel <span style="color: #268bd2; font-weight: bold;">%in%</span> parcels.w2buidings) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(Parcel) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    dplyr::select(BUILDINGFO, Shape_area) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    arrange(Parcel) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(Shape_area == min(Shape_area)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    pull(BUILDINGFO)


build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.res.primary.parcels[ ! build.res.primary.parcels@data$BUILDINGFO <span style="color: #268bd2; font-weight: bold;">%in%</span> build.to.remove,]

                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">If there are buildings that are in multiple parcels??</span>


</pre>
</div>

<pre class="example">
Warning message:
In split.default(a, rep(1:cores, each = ceiling(length(a)/cores))) :
  data length is not a multiple of split variable
Joining, by = "id"
Adding missing grouping variables: `Parcel`

</pre>


<div class="org-src-container">
<pre class="src src-R">writeOGR(build.res.primary.parcels, dsn = <span style="color: #2aa198;">"../DD/"</span>, layer = <span style="color: #2aa198;">"buildings.w.parcels.energy.propinfo"</span>, driver = <span style="color: #2aa198;">"ESRI Shapefile"</span>, overwrite = T)

saveRDS(colnames(build.res.primary.parcels@data), <span style="color: #2aa198;">"../DD/colnames.buildings.w.parcels.energy.propinfo.rds"</span>)
saveRDS(build.res.primary.parcels@data$Parcel, <span style="color: #2aa198;">"../DD/parcelID.buildings.w.parcels.energy.propinfo.rds"</span>)
saveRDS(build.res.primary.parcels@data$BUILDINGINFO, <span style="color: #2aa198;">"../DD/BUILDINGINFO.buildings.w.parcels.energy.propinfo.rds"</span>)
saveRDS(build.res.primary.parcels@data, <span style="color: #2aa198;">"../DD/data.buildings.w.parcels.energy.propinfo.rds"</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-orgac7ff29" class="outline-4">
<h4 id="orgac7ff29"><span class="section-number-4">1.4.8</span> make regions around each building</h4>
<div class="outline-text-4" id="text-1-4-8">
<p>
Note <span class="timestamp-wrapper"><span class="timestamp">[2018-09-24 Mon]</span></span>, this is an old figure.  An example of an early attempt at dividing
regions up.  The figure in the publication shows how I ultimately
divided regions.
</p>

<div class="figure">
<p><img src="file:///Users/erker/projects/energy/figs/Screenshot 2017-10-10 13.12.32.png" alt="Screenshot 2017-10-10 13.12.32.png" width="900" />
</p>
</div>



<div class="org-src-container">
<pre class="src src-R">build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readOGR(dsn = <span style="color: #2aa198;">"../DD/"</span>, layer = <span style="color: #2aa198;">"buildings.w.parcels.energy.propinfo"</span>, stringsAsFactors = F)
colnames(build.res.primary.parcels@data) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(<span style="color: #2aa198;">"../DD/colnames.buildings.w.parcels.energy.propinfo.rds"</span>)
</pre>
</div>

<p>
fix poly 27940.  It has bad topology
</p>
<div class="org-src-container">
<pre class="src src-R">build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bind(build.res.primary.parcels, gBuffer(build.res.primary.parcels[27940,], width = .001))

build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.res.primary.parcels[-27940,]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">cores <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 4
chunks <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 80
a <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1:length(build.res.primary.parcels)
a.s <span style="color: #268bd2; font-weight: bold;">&lt;-</span> split(a, rep(1:chunks,each = ceiling(length(a)/chunks)))

dir.create(<span style="color: #2aa198;">"../DD/buildings.regions.solarangles"</span>)

cl <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeCluster(cores)
registerDoParallel(cl)


foreach(i = a.s, .packages = c(<span style="color: #2aa198;">"plyr"</span>,<span style="color: #2aa198;">"sp"</span>,<span style="color: #2aa198;">"raster"</span>,<span style="color: #2aa198;">"rgeos"</span>), .combine = <span style="color: #2aa198;">"rbind"</span>) <span style="color: #268bd2; font-weight: bold;">%dopar%</span> {
    o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lapply(i, <span style="color: #859900; font-weight: bold;">function</span>(j) {
        print(j)
        op <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeRegionsAroundPolygonManyAngles(build.res.primary.parcels[j,])
    })
    o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> do.call(bind, o)
    shapefile(o, paste0(<span style="color: #2aa198;">"../DD/buildings.regions.solarangles/"</span>,i[1],<span style="color: #2aa198;">".shp"</span>), overwrite = T)
}

closeAllConnections()


shp.files <span style="color: #268bd2; font-weight: bold;">&lt;-</span> list.files(<span style="color: #2aa198;">"../DD/buildings.regions.solarangles"</span>, pattern = <span style="color: #2aa198;">".*shp"</span>, full.names = T)

cl <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeCluster(cores)
registerDoParallel(cl)

out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> foreach(shp.file = shp.files, .packages = c(<span style="color: #2aa198;">"sp"</span>,<span style="color: #2aa198;">"raster"</span>,<span style="color: #2aa198;">"rgeos"</span>)) <span style="color: #268bd2; font-weight: bold;">%dopar%</span> {
    shapefile(shp.file)
}

out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> do.call(bind, out)
</pre>
</div>
</div>
</div>

<div id="outline-container-org9b8f46a" class="outline-4">
<h4 id="org9b8f46a"><span class="section-number-4">1.4.9</span> fix colnames</h4>
<div class="outline-text-4" id="text-1-4-9">
<div class="org-src-container">
<pre class="src src-R">colnames(out@data) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"BUILDINGFO"</span>,<span style="color: #2aa198;">"distance.from.building"</span>,<span style="color: #2aa198;">"direction"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgba7005b" class="outline-4">
<h4 id="orgba7005b"><span class="section-number-4">1.4.10</span> save regions around buildings</h4>
<div class="outline-text-4" id="text-1-4-10">
<div class="org-src-container">
<pre class="src src-R">writeOGR(out, dsn = <span style="color: #2aa198;">"../DD/"</span>, layer = <span style="color: #2aa198;">"building.regions.solarangles"</span>, driver = <span style="color: #2aa198;">"ESRI Shapefile"</span>, overwrite = T)

                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">unlink("../DD/buildings.regions.15mNESW", recursive = T)</span>
</pre>
</div>

<pre class="example">
Warning message:
In writeOGR(out, dsn = "../DD/", layer = "building.regions.solarangles",  :
  Field names abbreviated for ESRI Shapefile driver

</pre>
</div>
</div>
</div>
<div id="outline-container-org9d5ecfb" class="outline-3">
<h3 id="org9d5ecfb"><span class="section-number-3">1.5</span> read in regions around buildings</h3>
<div class="outline-text-3" id="text-1-5">
<div class="org-src-container">
<pre class="src src-R">out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/building.regions.solarangles.shp"</span>)
colnames(out@data) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"BUILDINGFO"</span>,<span style="color: #2aa198;">"distance.from.building"</span>,<span style="color: #2aa198;">"direction"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org716e22f" class="outline-3">
<h3 id="org716e22f"><span class="section-number-3">1.6</span> Urban Tree Canopy Map</h3>
<div class="outline-text-3" id="text-1-6">

<div class="figure">
<p><img src="file:///Users/erker/projects/energy/figs/Screenshot 2017-10-10 12.45.21.png" alt="Screenshot 2017-10-10 12.45.21.png" width="1400" />
</p>
</div>
<div class="org-src-container">
<pre class="src src-R">utc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> raster(mad.utc.path)
</pre>
</div>
</div>
</div>
<div id="outline-container-org200525e" class="outline-3">
<h3 id="org200525e"><span class="section-number-3">1.7</span> Calculate Tree Cover within regions around each residential building</h3>
<div class="outline-text-3" id="text-1-7">
<p>
Reproject the building regions shapefile and save this transformation
</p>
<div class="org-src-container">
<pre class="src src-R">out2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> spTransform(out, proj4string(utc))
shapefile(out2,<span style="color: #2aa198;">"../DD/building.regions.solarangles_utcProj.shp"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">out2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/building.regions.solarangles_utcProj.shp"</span>)
colnames(out2@data) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"BUILDINGFO"</span>,<span style="color: #2aa198;">"distance.from.building"</span>,<span style="color: #2aa198;">"over.building"</span>,<span style="color: #2aa198;">"direction"</span>)
</pre>
</div>


<p>
extract the cover
</p>
<div class="org-src-container">
<pre class="src src-R">cores <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 4

dir.create(<span style="color: #2aa198;">"../DD/extracted.cover.solarangles"</span>)

chunks <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 100
a.s <span style="color: #268bd2; font-weight: bold;">&lt;-</span> split(1:length(out2), f = rep(1:chunks, each = ceiling(length(out2)/chunks)))

                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">chunks &lt;- 4</span>
                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">a.s &lt;- split(1:16, f = rep(1:chunks, each = ceiling(16/chunks)))</span>

o <span style="color: #268bd2; font-weight: bold;">&lt;-</span>      lapply(a.s, <span style="color: #859900; font-weight: bold;">function</span>(i) {
    res.set <span style="color: #268bd2; font-weight: bold;">&lt;-</span> extract.polygons.parallel(utc, out2[i,], cores = cores)
    res.u <span style="color: #268bd2; font-weight: bold;">&lt;-</span> unlist(res.set, recursive = F)
    saveRDS(res.u, paste0(<span style="color: #2aa198;">"../DD/extracted.cover.solarangles/eachRegionAroundBuilding_set"</span>,i[1],<span style="color: #2aa198;">".rds"</span>))
})

</pre>
</div>

<pre class="example">
Warning message:
In dir.create("../DD/extracted.cover.solarangles") :
  '../DD/extracted.cover.solarangles' already exists
Warning message:
In split.default(1:length(out2), f = rep(1:chunks, each = ceiling(length(out2)/chunks))) :
  data length is not a multiple of split variable

</pre>

<p>
summarize the cover
</p>
<div class="org-src-container">
<pre class="src src-R">res.u.list <span style="color: #268bd2; font-weight: bold;">&lt;-</span> list.files(<span style="color: #2aa198;">"../DD/extracted.cover.solarangles"</span>, full.names = T)

                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">put them in the correct order for reconstruction</span>
i <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as.numeric(str_extract(res.u.list, <span style="color: #2aa198;">"[0-9]+"</span>))
res.u.list <span style="color: #268bd2; font-weight: bold;">&lt;-</span> res.u.list[order(i)]


res.u <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lapply(res.u.list, readRDS)
res.u.u <span style="color: #268bd2; font-weight: bold;">&lt;-</span> unlist(res.u, recursive = F)

sum.tree.per.region <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sapply(res.u.u, <span style="color: #859900; font-weight: bold;">function</span>(x) sum(x == 1))
n.pixels.per.region <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sapply(res.u.u, <span style="color: #859900; font-weight: bold;">function</span>(x) length(x))

out2@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cbind(out2@data, sum.tree.per.region, n.pixels.per.region)

                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">out3 &lt;- out2[1:16,]</span>
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">out3@data &lt;- cbind(out3@data, sum.tree.per.region, n.pixels.per.region)</span>
</pre>
</div>
</div>


<div id="outline-container-orgb3a2e72" class="outline-4">
<h4 id="orgb3a2e72"><span class="section-number-4">1.7.1</span> spread to make a row for each building, rather than a row for each region</h4>
<div class="outline-text-4" id="text-1-7-1">
<div class="org-src-container">
<pre class="src src-R">
o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> out2@data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> unite_(<span style="color: #2aa198;">"direction.dist"</span>, c(<span style="color: #2aa198;">"direction"</span>,<span style="color: #2aa198;">"distance.from.building"</span>))
                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">o &lt;- out3@data %&gt;% unite_("direction.dist", c("direction","distance.from.building"))</span>


                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">some regions, say south 10m from a house are made or more than one polygon.  This combines them.</span>
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">probably not necessary with these larger buffers</span>
                                        <span style="color: #93a1a1;">#        </span><span style="color: #93a1a1;">o &lt;- o %&gt;% group_by(BUILDINGFO, direction.dist.overbuilding) %&gt;%</span>
                                        <span style="color: #93a1a1;">#            </span><span style="color: #93a1a1;">summarize(sum.tree.per.region = sum(sum.tree.per.region),</span>
                                        <span style="color: #93a1a1;">#                      </span><span style="color: #93a1a1;">n.pixels.per.region = sum(n.pixels.per.region))</span>

saveRDS(o, <span style="color: #2aa198;">"../DD/sum.tree_npixels_byregion_atbuildings_solarangles.rds"</span>)


o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> select(o,  -n.pixels.per.region)

o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> spread(o, key = direction.dist, value = sum.tree.per.region)

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7a017b4" class="outline-3">
<h3 id="org7a017b4"><span class="section-number-3">1.8</span> Join Tree cover to buildings</h3>
<div class="outline-text-3" id="text-1-8">
<div class="org-src-container">
<pre class="src src-R">build.res.primary.parcels <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/buildings.w.parcels.energy.propinfo"</span>, stringsAsFactors = F)
colnames(build.res.primary.parcels@data) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(<span style="color: #2aa198;">"../DD/colnames.buildings.w.parcels.energy.propinfo.rds"</span>)
                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">build.res.primary.parcels@data$BUILDINGFO &lt;- as.numeric(build.res.primary.parcels@data$BUILDINGFO)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">build.res.primary.parcels.tree <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.res.primary.parcels[build.res.primary.parcels@data$BUILDINGFO <span style="color: #268bd2; font-weight: bold;">%in%</span> o$BUILDINGFO, ]
build.res.primary.parcels.tree@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(build.res.primary.parcels.tree@data, o)
</pre>
</div>

<pre class="example">
Joining, by = "BUILDINGFO"

</pre>

<div class="org-src-container">
<pre class="src src-R">colnames(build.res.primary.parcels.tree@data)[57:64] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> paste0(<span style="color: #2aa198;">"d"</span>,colnames(build.res.primary.parcels.tree@data)[57:64],<span style="color: #2aa198;">"_tree"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">shapefile(as(build.res.primary.parcels.tree, <span style="color: #2aa198;">"SpatialPolygons"</span>), <span style="color: #2aa198;">"../DD/buildings.w.parcels.energy.propinfo_solarangles"</span>, overwrite = T)
saveRDS(colnames(build.res.primary.parcels.tree@data), <span style="color: #2aa198;">"../DD/colnames.buildings.w.parcels.energy.propinfo_solarangles.rds"</span>)
saveRDS(build.res.primary.parcels.tree$Parcel, <span style="color: #2aa198;">"../DD/Parcel.buildings.w.parcels.energy.propinfo_solarangles.rds"</span>)
saveRDS(build.res.primary.parcels.tree@data, <span style="color: #2aa198;">"../DD/data_buildings.w.parcels.energy.propinfo_solarangles.rds"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6bd74ce" class="outline-3">
<h3 id="org6bd74ce"><span class="section-number-3">1.9</span> Calculate Building Cover within regions around each residential building  There could be an error here which is causing me to lose some houses</h3>
<div class="outline-text-3" id="text-1-9">
</div>
<div id="outline-container-orgbe80199" class="outline-4">
<h4 id="orgbe80199"><span class="section-number-4">1.9.1</span> load shapefiles</h4>
<div class="outline-text-4" id="text-1-9-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(rgeos)
<span style="color: #268bd2; font-weight: bold;">library</span>(rgdal)
<span style="color: #268bd2; font-weight: bold;">library</span>(raster)
<span style="color: #268bd2; font-weight: bold;">library</span>(doParallel)
<span style="color: #268bd2; font-weight: bold;">library</span>(foreach)

build.regions <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/building.regions.solarangles.shp"</span>)

                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Just as a note about the area size of the regions.</span>
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">the near regions (just two examples:</span>
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">gArea(build.regions[6,]) = 812 meters^2</span>
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">gArea(build.regions[5,]) = 540 meters^2</span>
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">the far regions</span>
<span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">gArea(build.regions[1,])</span>
<span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">[1] 3897.304</span>
<span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">&gt; gArea(build.regions[2,])</span>
<span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">[1] 2323.741</span>


buildings <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"/Users/erker/git/energy/RD/dane_cty_building_footprint_2010/BuildingFootprint.shp"</span>)
buildings <span style="color: #268bd2; font-weight: bold;">&lt;-</span> spTransform(buildings, crs(build.regions))

                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">fix topology</span>
br <span style="color: #268bd2; font-weight: bold;">&lt;-</span> gBuffer(buildings,width = .0001, byid = T)
d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> buildings@data
buildings <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as(br, <span style="color: #2aa198;">"SpatialPolygonsDataFrame"</span>)
buildings@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> d

buildings <span style="color: #268bd2; font-weight: bold;">&lt;-</span> crop(buildings, extent(build.regions))

<span style="color: #93a1a1;">##   </span><span style="color: #93a1a1;">build.res.primary.parcels &lt;- readOGR(dsn = "../DD/", layer = "buildings.w.parcels.energy.propinfo")</span>
<span style="color: #93a1a1;">##   </span><span style="color: #93a1a1;">colnames(build.res.primary.parcels@data) &lt;- readRDS("../DD/colnames.buildings.w.parcels.energy.propinfo.rds")</span>
<span style="color: #93a1a1;">##   </span><span style="color: #93a1a1;">build.res.primary.parcels@data$Parcel &lt;- readRDS("../DD/parcelID.buildings.w.parcels.energy.propinfo.rds")</span>
<span style="color: #93a1a1;">##   </span><span style="color: #93a1a1;">build.res.primary.parcels@data$BUILDINGINFO &lt;- readRDS("../DD/BUILDINGINFO.buildings.w.parcels.energy.propinfo.rds")</span>

<span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">build.res.primary.parcels.reduced.data &lt;- build.res.primary.parcels</span>
<span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">build.res.primary.parcels.reduced.data@data &lt;-   build.res.primary.parcels.reduced.data@data %&gt;% dplyr::select(BUILDINGFO)</span>

                                        <span style="color: #93a1a1;">#      </span><span style="color: #93a1a1;">build.regions &lt;- shapefile("../DD/building.regions.3m16angles.shp")</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org3067914" class="outline-4">
<h4 id="org3067914"><span class="section-number-4">1.9.2</span> split building regions into 5000 chuncks (sent to krusty)</h4>
<div class="outline-text-4" id="text-1-9-2">
<div class="org-src-container">
<pre class="src src-R">
<span style="color: #268bd2; font-weight: bold;">library</span>(raster)
<span style="color: #268bd2; font-weight: bold;">library</span>(doParallel)
<span style="color: #268bd2; font-weight: bold;">library</span>(foreach)


dir.create(<span style="color: #2aa198;">"../DD/building.regions.solar.sections"</span>)
chunks <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 5000
a.s <span style="color: #268bd2; font-weight: bold;">&lt;-</span> split(1:length(build.regions), f = rep(1:chunks, each = ceiling(length(build.regions)/chunks)))

build.regions.list <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lapply(a.s, <span style="color: #859900; font-weight: bold;">function</span>(i) build.regions[i,])

cores <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 4
cl <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeCluster(cores)
registerDoParallel(cl)

foreach(build.region = build.regions.list, .packages = c(<span style="color: #2aa198;">"sp"</span>,<span style="color: #2aa198;">"raster"</span>)) <span style="color: #268bd2; font-weight: bold;">%dopar%</span> {
    shapefile(build.region, paste0(<span style="color: #2aa198;">"../DD/building.regions.solar.sections/building.regions_subset"</span>,build.region@data$BUILDIN[1]), overwrite = T)
}

</pre>
</div>
</div>
</div>

<div id="outline-container-org16b0541" class="outline-4">
<h4 id="org16b0541"><span class="section-number-4">1.9.3</span> get area of poiygons within another polygon</h4>
<div class="outline-text-4" id="text-1-9-3">
<div class="org-src-container">
<pre class="src src-R">
cores <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 4

dir.create(<span style="color: #2aa198;">"../DD/building.around.building.solarangles/"</span>)

build.regions.list <span style="color: #268bd2; font-weight: bold;">&lt;-</span> list.files(<span style="color: #2aa198;">"/Users/erker/projects/energy/DD/building.regions.solar.sections"</span>, pattern = <span style="color: #2aa198;">"*.shp"</span>, full.names = T)

cl <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeCluster(cores)
registerDoParallel(cl)


out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> foreach(build.region.name = build.regions.list, .packages = c(<span style="color: #2aa198;">"plyr"</span>,<span style="color: #2aa198;">"dplyr"</span>,<span style="color: #2aa198;">"magrittr"</span>,<span style="color: #2aa198;">"sp"</span>,<span style="color: #2aa198;">"raster"</span>,<span style="color: #2aa198;">"rgeos"</span>), .combine = <span style="color: #2aa198;">"rbind"</span>) <span style="color: #268bd2; font-weight: bold;">%dopar%</span> {

    build.region <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(build.region.name)
                                        <span style="color: #93a1a1;">#     </span><span style="color: #93a1a1;">build.region@data$region.area &lt;- round(gArea(build.region, byid = T),2)</span>

    <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">in order to get build.regions.list[4702] to work...</span>
                                        <span style="color: #93a1a1;">#         </span><span style="color: #93a1a1;">br &lt;- gBuffer(build.region,width = .0001, byid = T)</span>
                                        <span style="color: #93a1a1;">#        </span><span style="color: #93a1a1;">d &lt;- build.region@data</span>
                                        <span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">build.region &lt;- as(br, "SpatialPolygonsDataFrame")</span>
                                        <span style="color: #93a1a1;">#      </span><span style="color: #93a1a1;">build.region@data &lt;- d</span>

    o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> raster::intersect(build.region, buildings)
    <span style="color: #859900; font-weight: bold;">if</span>(!is.null(o)) {

        o@data$area <span style="color: #268bd2; font-weight: bold;">&lt;-</span> round(gArea(o, byid = T),2)
        df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(build.region@data, o@data) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            dplyr::mutate(area = ifelse(is.na(area), 0, area)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            ungroup() <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
                                        <span style="color: #93a1a1;">#        </span><span style="color: #93a1a1;">group_by(BUILDIN, dstnc__, directn, region.area) %&gt;%</span>
            group_by(BUILDIN, dstnc__, directn) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            dplyr::summarize(area = sum(area))
    } <span style="color: #859900; font-weight: bold;">else</span> {

        df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> build.region@data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            mutate(area = 0)
    }


    saveRDS(df, paste0(<span style="color: #2aa198;">"../DD/building.around.building.solarangles/"</span>,build.region@data$BUILDIN[1],<span style="color: #2aa198;">".rds"</span>))
    df
}

closeAllConnections()

</pre>
</div>
</div>
</div>


<div id="outline-container-orgffa1aea" class="outline-4">
<h4 id="orgffa1aea"><span class="section-number-4">1.9.4</span> save out</h4>
<div class="outline-text-4" id="text-1-9-4">
<div class="org-src-container">
<pre class="src src-R">
res.u.list <span style="color: #268bd2; font-weight: bold;">&lt;-</span> list.files(<span style="color: #2aa198;">"../DD/building.around.building.solarangles"</span>, full.names = T, pattern = )

res.u <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lapply(res.u.list, readRDS)

res.u.u <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bind_rows(res.u)

saveRDS(res.u.u, <span style="color: #2aa198;">"../DD/building.around.building.solarangles.rds"</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc9cd6c3" class="outline-3">
<h3 id="orgc9cd6c3"><span class="section-number-3">1.10</span> Join Building Cover to Buildings</h3>
<div class="outline-text-3" id="text-1-10">
<p>
buildings in regions around buildings
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)

buildings.in.regions <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(<span style="color: #2aa198;">"../DD/building.around.building.solarangles.rds"</span>)


abuildings.in.regions <span style="color: #268bd2; font-weight: bold;">&lt;-</span> buildings.in.regions <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> unite_(<span style="color: #2aa198;">"direction.dist"</span>, c(<span style="color: #2aa198;">"directn"</span>, <span style="color: #2aa198;">"dstnc__"</span>))

buildings.in.regions <span style="color: #268bd2; font-weight: bold;">&lt;-</span> abuildings.in.regions <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(direction.dist = paste0(<span style="color: #2aa198;">"d"</span>,direction.dist, <span style="color: #2aa198;">"_building"</span>))

                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">remove trouble buildings</span>
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">buildings.in.regions &lt;- filter(buildings.in.regions, BUILDIN != 190246)</span>

                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">some regions, say south 10m from a house are made or more than one polygon.  This combines them.</span>
                                        <span style="color: #93a1a1;">#            </span><span style="color: #93a1a1;">b &lt;- b %&gt;% group_by(BUILDIN, direction.dist.overbuilding) %&gt;%</span>
                                        <span style="color: #93a1a1;">#               </span><span style="color: #93a1a1;">summarize(area = sum(area))</span>


bs <span style="color: #268bd2; font-weight: bold;">&lt;-</span> spread(buildings.in.regions, key = direction.dist, value = area)

</pre>
</div>

<p>
prop info and tree cover in regions around buildings
</p>
<div class="org-src-container">
<pre class="src src-R">buildings.propinfo.energy.tree <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"../DD/buildings.w.parcels.energy.propinfo_solarangles"</span>)

buildings.propinfo.energy.tree@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(<span style="color: #2aa198;">"../DD/data_buildings.w.parcels.energy.propinfo_solarangles.rds"</span>)

                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">remove trouble buildings</span>
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">buildings.propinfo.energy.tree &lt;- buildings.propinfo.energy.tree[which(buildings.propinfo.energy.tree@data$BUILDIN != 190246),]</span>

</pre>
</div>

<p>
Join
</p>
<div class="org-src-container">
<pre class="src src-R">d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(buildings.propinfo.energy.tree@data, bs, c(<span style="color: #2aa198;">"BUILDINGFO"</span> = <span style="color: #2aa198;">"BUILDIN"</span>))
buildings.propinfo.energy.tree@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> d
</pre>
</div>

<p>
save
</p>
<div class="org-src-container">
<pre class="src src-R">buildings.propinfo.energy.tree.building <span style="color: #268bd2; font-weight: bold;">&lt;-</span> buildings.propinfo.energy.tree
shapefile(buildings.propinfo.energy.tree.building, <span style="color: #2aa198;">"../DD/buildings.w.parcels.energy.propinfo.tree.building.shp"</span>, overwrite = T)
saveRDS(colnames(buildings.propinfo.energy.tree.building@data), <span style="color: #2aa198;">"../DD/buildings.w.parcels.energy.propinfo.tree.building.colnames.rds"</span>)
saveRDS(buildings.propinfo.energy.tree.building@data, <span style="color: #2aa198;">"../DD/buildings.w.parcels.energy.propinfo.tree.building.data.rds"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org33ca352" class="outline-3">
<h3 id="org33ca352"><span class="section-number-3">1.11</span> Model</h3>
<div class="outline-text-3" id="text-1-11">
</div>
<div id="outline-container-orgbc4133e" class="outline-4">
<h4 id="orgbc4133e"><span class="section-number-4">1.11.1</span> full df</h4>
<div class="outline-text-4" id="text-1-11-1">
<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readRDS(<span style="color: #2aa198;">"../DD/buildings.w.parcels.energy.propinfo.tree.building.data.rds"</span>)
</pre>
</div>

<p>
CHange "NA" Garage.1 to "none"
</p>
<div class="org-src-container">
<pre class="src src-R">df$Garage.1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as.character(df$Garage.1)
df$Garage.1[is.na(df$Garage.1)] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"none"</span>
</pre>
</div>

<p>
Remove houses with "0" current value - missing data
</p>
<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> filter(df, Current.Year.Land.Value.th != 0)
</pre>
</div>

<p>
Roof Replace Year and year built to numeric
</p>
<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> mutate(df, Roof.Replaced.Year = as.numeric(Roof.Replaced.Year),
             Year.Built = as.numeric(Year.Built))
</pre>
</div>

<p>
Only Gas Heating:
</p>
<div class="org-src-container">
<pre class="src src-R">df  <span style="color: #268bd2; font-weight: bold;">&lt;-</span>  df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(Electric_for_Heating == <span style="color: #2aa198;">"No"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> mutate(df,
             kWh_High_C = kWh2kgC(kWh_High),
             kWh_Annual_Avg_C = kWh2kgC(12*kWh_Mon_Avg_last12mo),
             Therms_High_C = therm2kgC(Therms_High),
             Therms_Annual_Avg_C = therm2kgC(12*Therms_Mon_Avg_last12mo),
             C_gas_and_elec_Annual_avg = kWh_Annual_Avg_C + Therms_Annual_Avg_C,
             log_C_gas_and_elec_Annual_avg = log(C_gas_and_elec_Annual_avg),
             log_C_elec_high = log(kWh_High_C),
             log_C_gas_high = log(Therms_High_C),
             log_C_elec_Annual_avg = log(kWh_Annual_Avg_C),
             log_C_gas_Annual_avg = log(Therms_Annual_Avg_C),
             log_kWh_High = log(kWh_High),
             log_Therms_High = log(Therms_High),
             log_kWh_Annual_Avg = log(12*kWh_Mon_Avg_last12mo),
             log_Therms_Annual_Avg = log(12*Therms_Mon_Avg_last12mo),
             log_Cost_gas_and_elec_Annual_avg = log(12*(Cost_Therms_Avg + Cost_kWh_Avg)))

df <span style="color: #268bd2; font-weight: bold;">&lt;-</span>  df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> dplyr::filter(Therms_Mon_Avg_last12mo &gt; 10, kWh_Mon_Avg_last12mo &gt; 20)

</pre>
</div>
</div>
</div>

<div id="outline-container-orgc04b992" class="outline-4">
<h4 id="orgc04b992"><span class="section-number-4">1.11.2</span> PCA of building covariates</h4>
<div class="outline-text-4" id="text-1-11-2">
<div class="org-src-container">
<pre class="src src-R">  <span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)

  pca.building.covariates <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"Lot.Size.Sq.Ft"</span>,
                               <span style="color: #2aa198;">"Water.Frontage"</span>,  <span style="color: #2aa198;">"Year.Built"</span>,
                               <span style="color: #2aa198;">"Stories"</span>, <span style="color: #2aa198;">"Bedrooms"</span>, <span style="color: #2aa198;">"Full.Baths"</span>, <span style="color: #2aa198;">"Half.Baths"</span>, <span style="color: #2aa198;">"Fireplaces"</span>,
                               <span style="color: #2aa198;">"First.Floor.Living.Area"</span>, <span style="color: #2aa198;">"Second.Floor.Living.Area"</span>,
                               <span style="color: #2aa198;">"Third.Floor.Living.Area"</span>, <span style="color: #2aa198;">"Finished.Attic"</span>,
                               <span style="color: #2aa198;">"Finished.Basement"</span>, <span style="color: #2aa198;">"Total.Basement"</span>, <span style="color: #2aa198;">"Crawl.Space"</span>,
                               <span style="color: #2aa198;">"Roof.Replaced.Year"</span>,
                               <span style="color: #2aa198;">"Garage.Stalls.1"</span>, <span style="color: #2aa198;">"Garage.Stalls.2"</span>,
                               <span style="color: #2aa198;">"Current.Year.Improvement.Value.th"</span>, <span style="color: #2aa198;">"Current.Year.Land.Value.th"</span>)

  bc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df[,pca.building.covariates]
  bc[is.na(bc)] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"None"</span>
  bc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bc <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate_if(is.character,as.factor)
  bc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bc <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate_if(is.factor,as.numeric)

  to.log.transform <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"Lot.Size.Sq.Ft"</span>,<span style="color: #2aa198;">"First.Floor.Living.Area"</span>, <span style="color: #2aa198;">"Second.Floor.Living.Area"</span>,
                        <span style="color: #2aa198;">"Third.Floor.Living.Area"</span>, <span style="color: #2aa198;">"Finished.Attic"</span>, <span style="color: #2aa198;">"Finished.Basement"</span>,
                        <span style="color: #2aa198;">"Total.Basement"</span>, <span style="color: #2aa198;">"Crawl.Space"</span>,
                        <span style="color: #2aa198;">"Current.Year.Improvement.Value.th"</span>, <span style="color: #2aa198;">"Current.Year.Land.Value.th"</span>)

  df[to.log.transform] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data.frame(lapply(df[to.log.transform], as.numeric))
  bc[to.log.transform] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> log(df[to.log.transform] + 1)

  outliers <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(4420,28,54,74,79,4379)

                                          <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">make NA's a level in factor</span>
  bc.o <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bc[-outliers,]

  pca <span style="color: #268bd2; font-weight: bold;">&lt;-</span> prcomp(bc.o, scale. = T)

                                          <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">plot(pca)</span>
                                          <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">biplot(pca)</span>
<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">cumsum((pca$sdev)^2) / sum(pca$sdev^2)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df[-outliers,]
df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df[, -which(names(df) <span style="color: #268bd2; font-weight: bold;">%in%</span> pca.building.covariates)]
building.pca <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data.frame(pca$x[,1:7])
colnames(building.pca) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> paste0(<span style="color: #2aa198;">"building.pca_"</span>,1:7)
df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bind_cols(df, building.pca)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7caa606" class="outline-4">
<h4 id="org7caa606"><span class="section-number-4">1.11.3</span> remove useless variables</h4>
<div class="outline-text-4" id="text-1-11-3">
<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> select(-BUILDINGFO, -SOURCE, -FootprintT, -BuildingUs, -BuildingCl, -Name, -Shape_area, -Shape_len, -Parcel, -Address, -Dwelling.Units, -Above.Third.Floor.Living.Area, -Total.Living.Area)
</pre>
</div>
</div>
</div>
<div id="outline-container-org21413bc" class="outline-4">
<h4 id="org21413bc"><span class="section-number-4">1.11.4</span> remove a few more not useful covariates</h4>
<div class="outline-text-4" id="text-1-11-4">
<div class="org-src-container">
<pre class="src src-R">
covariates.to.remove <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"Ward"</span>,<span style="color: #2aa198;">"State.Assembly.District"</span>,<span style="color: #2aa198;">"Home.Style"</span>,<span style="color: #2aa198;">"Above.Third.Floor.Living.Area"</span>,
                          <span style="color: #2aa198;">"Exterior.Wall.1"</span>,  <span style="color: #2aa198;">"Exterior.Wall.2"</span>,
                          <span style="color: #2aa198;">"Foundation"</span>,<span style="color: #2aa198;">"Roof"</span>, <span style="color: #2aa198;">"Garage.1"</span>,
                          <span style="color: #2aa198;">"Garage2"</span>,<span style="color: #2aa198;">"Driveway"</span>, <span style="color: #2aa198;">"Middle.School"</span>,<span style="color: #2aa198;">"High.School"</span>)
df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df[, -which(names(df) <span style="color: #268bd2; font-weight: bold;">%in%</span> covariates.to.remove)]

</pre>
</div>
</div>
</div>
<div id="outline-container-orga251665" class="outline-4">
<h4 id="orga251665"><span class="section-number-4">1.11.5</span> rescale tree and building area divide by 100</h4>
<div class="outline-text-4" id="text-1-11-5">
<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate_at(vars(starts_with(<span style="color: #2aa198;">"d"</span>)), funs(./100))
</pre>
</div>

<p>
It's possible to fit about 5, 100m<sup>2</sup> trees in the near east or near
west regions I created.  So multiply the coefficient by 5 and that's
the effect of filling the space within 20m of house with trees.
</p>
</div>
</div>


<div id="outline-container-org6c83a5e" class="outline-4">
<h4 id="org6c83a5e"><span class="section-number-4">1.11.6</span> Fit Models</h4>
<div class="outline-text-4" id="text-1-11-6">
</div>
<ol class="org-ol">
<li><a id="org848729c"></a>Central Air = "true"<br />
<ol class="org-ol">
<li><a id="orgb53cede"></a>kg C<br />
<ol class="org-ol">
<li><a id="org27c469e"></a>log avg kg C from gas and elec combined, all near tree regions combined<br />
<div class="outline-text-7" id="text-1-11-6-1-1-1">
<div class="org-src-container">
<pre class="src src-R">
df.treecombined <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(tree = rowSums(select(., contains(<span style="color: #2aa198;">"_0_tree"</span>))))


C.avg.lmer.log.treecombined <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lmer(log_C_gas_and_elec_Annual_avg ~ building.pca_1 +
                                        building.pca_2 +
                                        building.pca_3 +
                                        building.pca_4 +
                                        building.pca_5 +
                                        <span style="color: #93a1a1;">#                                 </span><span style="color: #93a1a1;">building.pca_6 +</span>
                                        <span style="color: #93a1a1;">#                                </span><span style="color: #93a1a1;">building.pca_7 +</span>
                                        tree +
                                        (1|Elementary.School)
                                  , data = filter(df.treecombined, Central.Air == <span style="color: #2aa198;">"true"</span>))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(glance(C.avg.lmer.log.treecombined))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | sigma |   logLik |      AIC |      BIC | deviance | df.residual |</span>
<span style="color: #859900;">|---+-------+----------+----------+----------+----------+-------------|</span>
<span style="color: #859900;">| 1 |  0.30 | -5026.95 | 10071.91 | 10144.93 |  9977.51 |    24674.00 |</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(tidy(C.avg.lmer.log.treecombined))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | term                             | estimate | std.error | statistic | group             |</span>
<span style="color: #859900;">|---+----------------------------------+----------+-----------+-----------+-------------------|</span>
<span style="color: #859900;">| 1 | (Intercept)                      |     7.77 |      0.01 |    878.94 | fixed             |</span>
<span style="color: #859900;">| 2 | building.pca_1                   |     0.09 |      0.00 |     81.39 | fixed             |</span>
<span style="color: #859900;">| 3 | building.pca_2                   |     0.01 |      0.00 |      4.85 | fixed             |</span>
<span style="color: #859900;">| 4 | building.pca_3                   |     0.02 |      0.00 |     11.16 | fixed             |</span>
<span style="color: #859900;">| 5 | building.pca_4                   |     0.03 |      0.00 |     14.26 | fixed             |</span>
<span style="color: #859900;">| 6 | building.pca_5                   |     0.00 |      0.00 |      2.13 | fixed             |</span>
<span style="color: #859900;">| 7 | tree                             |     0.00 |      0.00 |      3.84 | fixed             |</span>
<span style="color: #859900;">| 8 | sd_(Intercept).Elementary.School |     0.03 |           |           | Elementary.School |</span>
<span style="color: #859900;">| 9 | sd_Observation.Residual          |     0.30 |           |           | Residual          |</span>
</pre>
</div>


<div class="figure">
<p><img src="../figs/C_avg_resid.png" alt="C_avg_resid.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/treeCombined_avg_C_coefs.png" alt="treeCombined_avg_C_coefs.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate - 1.96 * a$std)
pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate)
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate + 1.96 * a$std)

lower
pt
upper

(c(lower,pt,upper) - 1) * 100

</pre>
</div>

<pre class="example">
[1] 1.000869
[1] 1.001776
[1] 1.002685
[1] 0.08686037 0.17764132 0.26850461

</pre>
</div>
</li>

<li><a id="orgb3b4510"></a>log avg kg C from gas and elec combined<br />
<div class="outline-text-7" id="text-1-11-6-1-1-2">
<div class="org-src-container">
<pre class="src src-R">
C.avg.lmer.log <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lmer(log_C_gas_and_elec_Annual_avg ~ building.pca_1 +
                           building.pca_2 +
                           building.pca_3 +
                           building.pca_4 +
                           building.pca_5 +
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_6 +</span>
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_7 +</span>
                           d0_0_tree        +
                           d0_20_tree       +
                           d180_0_tree      +
                           d180_20_tree     +
                           d270_0_tree      +
                           d270_20_tree     +
                           d90_0_tree       +
                           d90_20_tree      +
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d0_0_building    +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d0_20_building   +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d180_0_building  +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d180_20_building +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d270_0_building  +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d270_20_building +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d90_0_building   +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d90_20_building  +</span>
                           (1|Elementary.School)
                     , data = filter(df, Central.Air == <span style="color: #2aa198;">"true"</span>))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(glance(C.avg.lmer.log))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | sigma |   logLik |      AIC |      BIC | deviance | df.residual |</span>
<span style="color: #859900;">|---+-------+----------+----------+----------+----------+-------------|</span>
<span style="color: #859900;">| 1 |  0.30 | -5067.27 | 10166.54 | 10296.36 |  9971.51 |    24667.00 |</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(tidy(C.avg.lmer.log))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|    | term                             | estimate | std.error | statistic | group             |</span>
<span style="color: #859900;">|----+----------------------------------+----------+-----------+-----------+-------------------|</span>
<span style="color: #859900;">|  1 | (Intercept)                      |     7.77 |      0.01 |    788.38 | fixed             |</span>
<span style="color: #859900;">|  2 | building.pca_1                   |     0.09 |      0.00 |     81.30 | fixed             |</span>
<span style="color: #859900;">|  3 | building.pca_2                   |     0.01 |      0.00 |      4.83 | fixed             |</span>
<span style="color: #859900;">|  4 | building.pca_3                   |     0.02 |      0.00 |     10.82 | fixed             |</span>
<span style="color: #859900;">|  5 | building.pca_4                   |     0.03 |      0.00 |     13.94 | fixed             |</span>
<span style="color: #859900;">|  6 | building.pca_5                   |     0.00 |      0.00 |      2.02 | fixed             |</span>
<span style="color: #859900;">|  7 | d0_0_tree                        |     0.00 |      0.00 |      0.08 | fixed             |</span>
<span style="color: #859900;">|  8 | d0_20_tree                       |     0.00 |      0.00 |      0.33 | fixed             |</span>
<span style="color: #859900;">|  9 | d180_0_tree                      |     0.00 |      0.00 |      0.86 | fixed             |</span>
<span style="color: #859900;">| 10 | d180_20_tree                     |     0.00 |      0.00 |      0.45 | fixed             |</span>
<span style="color: #859900;">| 11 | d270_0_tree                      |     0.00 |      0.00 |      0.23 | fixed             |</span>
<span style="color: #859900;">| 12 | d270_20_tree                     |     0.00 |      0.00 |      0.85 | fixed             |</span>
<span style="color: #859900;">| 13 | d90_0_tree                       |     0.00 |      0.00 |      2.22 | fixed             |</span>
<span style="color: #859900;">| 14 | d90_20_tree                      |     0.00 |      0.00 |      0.80 | fixed             |</span>
<span style="color: #859900;">| 15 | sd_(Intercept).Elementary.School |     0.03 |           |           | Elementary.School |</span>
<span style="color: #859900;">| 16 | sd_Observation.Residual          |     0.30 |           |           | Residual          |</span>
</pre>
</div>


<div class="figure">
<p><img src="../figs/C_avg_resid.png" alt="C_avg_resid.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/tree_avg_C_coefs.png" alt="tree_avg_C_coefs.png" />
</p>
</div>
</div>
</li>



<li><a id="org6974519"></a>log avg kg C from gas, all near tree regions combined<br />
<div class="outline-text-7" id="text-1-11-6-1-1-3">
<div class="org-src-container">
<pre class="src src-R">
df.treecombined <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(tree = rowSums(select(., contains(<span style="color: #2aa198;">"_0_tree"</span>))))


C.gas.lmer.log.treecombined <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lmer(log_C_gas_Annual_avg ~ building.pca_1 +
                                        building.pca_2 +
                                        building.pca_3 +
                                        building.pca_4 +
                                        building.pca_5 +
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_6 +</span>
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_7 +</span>
                                        tree +
                                        (1|Elementary.School)
                                  , data = filter(df.treecombined, Central.Air == <span style="color: #2aa198;">"true"</span>))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(glance(C.gas.lmer.log.treecombined))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | sigma |   logLik |     AIC |     BIC | deviance | df.residual |</span>
<span style="color: #859900;">|---+-------+----------+---------+---------+----------+-------------|</span>
<span style="color: #859900;">| 1 |  0.28 | -3936.22 | 7890.43 | 7963.46 |  7795.88 |    24674.00 |</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(tidy(C.gas.lmer.log.treecombined))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | term                             | estimate | std.error | statistic | group             |</span>
<span style="color: #859900;">|---+----------------------------------+----------+-----------+-----------+-------------------|</span>
<span style="color: #859900;">| 1 | (Intercept)                      |     6.76 |      0.01 |    691.89 | fixed             |</span>
<span style="color: #859900;">| 2 | building.pca_1                   |     0.09 |      0.00 |     85.80 | fixed             |</span>
<span style="color: #859900;">| 3 | building.pca_2                   |     0.03 |      0.00 |     17.70 | fixed             |</span>
<span style="color: #859900;">| 4 | building.pca_3                   |     0.05 |      0.00 |     25.49 | fixed             |</span>
<span style="color: #859900;">| 5 | building.pca_4                   |     0.04 |      0.00 |     19.55 | fixed             |</span>
<span style="color: #859900;">| 6 | building.pca_5                   |     0.01 |      0.00 |      7.43 | fixed             |</span>
<span style="color: #859900;">| 7 | tree                             |     0.01 |      0.00 |     17.19 | fixed             |</span>
<span style="color: #859900;">| 8 | sd_(Intercept).Elementary.School |     0.04 |           |           | Elementary.School |</span>
<span style="color: #859900;">| 9 | sd_Observation.Residual          |     0.28 |           |           | Residual          |</span>
</pre>
</div>


<div class="figure">
<p><img src="../figs/C_combinedtree_gas_resid.png" alt="C_combinedtree_gas_resid.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/treeCombined_gas_C_coefs.png" alt="treeCombined_gas_C_coefs.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-R">lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate - 1.96 * a$std)
pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate)
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate + 1.96 * a$std)

lower
pt
upper
</pre>
</div>

<pre class="example">
[1] 1.006774
[1] 1.00765
[1] 1.008525

</pre>
</div>
</li>

<li><a id="org83f47c6"></a>log avg kg C from gas<br />
<div class="outline-text-7" id="text-1-11-6-1-1-4">
<div class="org-src-container">
<pre class="src src-R">C.gas.lmer.log <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lmer(log_C_gas_Annual_avg ~ building.pca_1 +
                           building.pca_2 +
                           building.pca_3 +
                           building.pca_4 +
                           building.pca_5 +
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_6 +</span>
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_7 +</span>
                           d0_0_tree        +
                           d0_20_tree       +
                           d180_0_tree      +
                           d180_20_tree     +
                           d270_0_tree      +
                           d270_20_tree     +
                           d90_0_tree       +
                           d90_20_tree      +
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d0_0_building    +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d0_20_building   +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d180_0_building  +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d180_20_building +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d270_0_building  +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d270_20_building +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d90_0_building   +</span>
                           <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d90_20_building  +</span>
                           (1|Elementary.School)
                     , data = filter(df, Central.Air == <span style="color: #2aa198;">"true"</span>))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(glance(C.gas.lmer.log))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | sigma |   logLik |     AIC |     BIC | deviance | df.residual |</span>
<span style="color: #859900;">|---+-------+----------+---------+---------+----------+-------------|</span>
<span style="color: #859900;">| 1 |  0.28 | -3963.38 | 7958.76 | 8088.58 |  7762.93 |    24667.00 |</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(tidy(C.gas.lmer.log))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|    | term                             | estimate | std.error | statistic | group             |</span>
<span style="color: #859900;">|----+----------------------------------+----------+-----------+-----------+-------------------|</span>
<span style="color: #859900;">|  1 | (Intercept)                      |     6.74 |      0.01 |    637.21 | fixed             |</span>
<span style="color: #859900;">|  2 | building.pca_1                   |     0.09 |      0.00 |     85.73 | fixed             |</span>
<span style="color: #859900;">|  3 | building.pca_2                   |     0.03 |      0.00 |     17.66 | fixed             |</span>
<span style="color: #859900;">|  4 | building.pca_3                   |     0.04 |      0.00 |     24.59 | fixed             |</span>
<span style="color: #859900;">|  5 | building.pca_4                   |     0.04 |      0.00 |     18.73 | fixed             |</span>
<span style="color: #859900;">|  6 | building.pca_5                   |     0.01 |      0.00 |      7.02 | fixed             |</span>
<span style="color: #859900;">|  7 | d0_0_tree                        |     0.00 |      0.00 |      3.68 | fixed             |</span>
<span style="color: #859900;">|  8 | d0_20_tree                       |     0.00 |      0.00 |      1.57 | fixed             |</span>
<span style="color: #859900;">|  9 | d180_0_tree                      |     0.01 |      0.00 |      6.92 | fixed             |</span>
<span style="color: #859900;">| 10 | d180_20_tree                     |     0.00 |      0.00 |      2.13 | fixed             |</span>
<span style="color: #859900;">| 11 | d270_0_tree                      |     0.00 |      0.00 |      1.97 | fixed             |</span>
<span style="color: #859900;">| 12 | d270_20_tree                     |     0.00 |      0.00 |      1.64 | fixed             |</span>
<span style="color: #859900;">| 13 | d90_0_tree                       |     0.01 |      0.00 |      3.92 | fixed             |</span>
<span style="color: #859900;">| 14 | d90_20_tree                      |     0.00 |      0.00 |      2.01 | fixed             |</span>
<span style="color: #859900;">| 15 | sd_(Intercept).Elementary.School |     0.04 |           |           | Elementary.School |</span>
<span style="color: #859900;">| 16 | sd_Observation.Residual          |     0.28 |           |           | Residual          |</span>
</pre>
</div>



<div class="figure">
<p><img src="../figs/C_gas_resid.png" alt="C_gas_resid.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/tree_avg_C_gas_coefs.png" alt="tree_avg_C_gas_coefs.png" />
</p>
</div>
</div>
</li>

<li><a id="orge9c9cf4"></a>log avg kg C from elec, all near tree regions combined<br />
<div class="outline-text-7" id="text-1-11-6-1-1-5">
<div class="org-src-container">
<pre class="src src-R">
df.treecombined <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(tree = rowSums(select(., contains(<span style="color: #2aa198;">"_0_tree"</span>))))


C.elec.lmer.log.treecombined <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lmer(log_C_elec_Annual_avg ~ building.pca_1 +
                                         building.pca_2 +
                                         building.pca_3 +
                                         building.pca_4 +
                                         building.pca_5 +
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_6 +</span>
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_7 +</span>
                                        tree +
                                        (1|Elementary.School)
                                   , data = filter(df.treecombined, Central.Air == <span style="color: #2aa198;">"true"</span>))

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(glance(C.elec.lmer.log.treecombined))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | sigma |    logLik |      AIC |      BIC | deviance | df.residual |</span>
<span style="color: #859900;">|---+-------+-----------+----------+----------+----------+-------------|</span>
<span style="color: #859900;">| 1 |  0.43 | -14292.56 | 28603.11 | 28676.14 | 28514.29 |    24674.00 |</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(tidy(C.elec.lmer.log.treecombined))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | term                             | estimate | std.error | statistic | group             |</span>
<span style="color: #859900;">|---+----------------------------------+----------+-----------+-----------+-------------------|</span>
<span style="color: #859900;">| 1 | (Intercept)                      |     7.28 |      0.01 |    512.23 | fixed             |</span>
<span style="color: #859900;">| 2 | building.pca_1                   |     0.09 |      0.00 |     56.25 | fixed             |</span>
<span style="color: #859900;">| 3 | building.pca_2                   |    -0.01 |      0.00 |     -2.10 | fixed             |</span>
<span style="color: #859900;">| 4 | building.pca_3                   |     0.00 |      0.00 |      0.37 | fixed             |</span>
<span style="color: #859900;">| 5 | building.pca_4                   |     0.02 |      0.00 |      7.46 | fixed             |</span>
<span style="color: #859900;">| 6 | building.pca_5                   |    -0.00 |      0.00 |     -1.32 | fixed             |</span>
<span style="color: #859900;">| 7 | tree                             |    -0.00 |      0.00 |     -3.14 | fixed             |</span>
<span style="color: #859900;">| 8 | sd_(Intercept).Elementary.School |     0.06 |           |           | Elementary.School |</span>
<span style="color: #859900;">| 9 | sd_Observation.Residual          |     0.43 |           |           | Residual          |</span>
</pre>
</div>


<div class="figure">
<p><img src="../figs/C_elec_treecombined_resid.png" alt="C_elec_treecombined_resid.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/treeCombined_elec_C_coefs.png" alt="treeCombined_elec_C_coefs.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate - 1.96 * a$std)
pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate)
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(a$estimate + 1.96 * a$std)

(lower -1) *100
(pt -1)*100
(upper -1)*100
</pre>
</div>

<pre class="example">
[1] -0.343475
[1] -0.2117033
[1] -0.07975729

</pre>
</div>
</li>

<li><a id="org6e1dfe0"></a>log avg kg C from elec<br />
<div class="outline-text-7" id="text-1-11-6-1-1-6">
<div class="org-src-container">
<pre class="src src-R">C.elec.lmer.log <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lmer(log_C_elec_Annual_avg ~ building.pca_1 +
                            building.pca_2 +
                            building.pca_3 +
                            building.pca_4 +
                            building.pca_5 +
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_6 +</span>
                                        <span style="color: #93a1a1;">#                               </span><span style="color: #93a1a1;">building.pca_7 +</span>
                            d0_0_tree        +
                            d0_20_tree       +
                            d180_0_tree      +
                            d180_20_tree     +
                            d270_0_tree      +
                            d270_20_tree     +
                            d90_0_tree       +
                            d90_20_tree      +
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d0_0_building    +</span>
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d0_20_building   +</span>
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d180_0_building  +</span>
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d180_20_building +</span>
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d270_0_building  +</span>
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d270_20_building +</span>
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d90_0_building   +</span>
                            <span style="color: #93a1a1;">## </span><span style="color: #93a1a1;">d90_20_building  +</span>
                            (1|Elementary.School)
                      , data = filter(df, Central.Air == <span style="color: #2aa198;">"true"</span>))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(glance(C.elec.lmer.log))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|   | sigma |    logLik |      AIC |      BIC | deviance | df.residual |</span>
<span style="color: #859900;">|---+-------+-----------+----------+----------+----------+-------------|</span>
<span style="color: #859900;">| 1 |  0.43 | -14330.96 | 28693.93 | 28823.75 | 28509.74 |    24667.00 |</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ascii.nowarn.print(tidy(C.elec.lmer.log))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #859900;">|    | term                             | estimate | std.error | statistic | group             |</span>
<span style="color: #859900;">|----+----------------------------------+----------+-----------+-----------+-------------------|</span>
<span style="color: #859900;">|  1 | (Intercept)                      |     7.28 |      0.02 |    467.44 | fixed             |</span>
<span style="color: #859900;">|  2 | building.pca_1                   |     0.09 |      0.00 |     56.20 | fixed             |</span>
<span style="color: #859900;">|  3 | building.pca_2                   |    -0.00 |      0.00 |     -2.09 | fixed             |</span>
<span style="color: #859900;">|  4 | building.pca_3                   |     0.00 |      0.00 |      0.36 | fixed             |</span>
<span style="color: #859900;">|  5 | building.pca_4                   |     0.02 |      0.00 |      7.42 | fixed             |</span>
<span style="color: #859900;">|  6 | building.pca_5                   |    -0.00 |      0.00 |     -1.28 | fixed             |</span>
<span style="color: #859900;">|  7 | d0_0_tree                        |    -0.00 |      0.00 |     -1.64 | fixed             |</span>
<span style="color: #859900;">|  8 | d0_20_tree                       |    -0.00 |      0.00 |     -0.07 | fixed             |</span>
<span style="color: #859900;">|  9 | d180_0_tree                      |    -0.00 |      0.00 |     -2.22 | fixed             |</span>
<span style="color: #859900;">| 10 | d180_20_tree                     |    -0.00 |      0.00 |     -0.48 | fixed             |</span>
<span style="color: #859900;">| 11 | d270_0_tree                      |    -0.00 |      0.00 |     -0.80 | fixed             |</span>
<span style="color: #859900;">| 12 | d270_20_tree                     |     0.00 |      0.00 |      0.27 | fixed             |</span>
<span style="color: #859900;">| 13 | d90_0_tree                       |     0.00 |      0.00 |      1.04 | fixed             |</span>
<span style="color: #859900;">| 14 | d90_20_tree                      |     0.00 |      0.00 |      0.30 | fixed             |</span>
<span style="color: #859900;">| 15 | sd_(Intercept).Elementary.School |     0.06 |           |           | Elementary.School |</span>
<span style="color: #859900;">| 16 | sd_Observation.Residual          |     0.43 |           |           | Residual          |</span>
</pre>
</div>



<div class="figure">
<p><img src="../figs/C_elec_resid.png" alt="C_elec_resid.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/tree_avg_C_elec_coefs.png" alt="tree_avg_C_elec_coefs.png" />
</p>
</div>





<div class="figure">
<p><img src="../figs/tree_avg_C_elec_coefs2.png" alt="tree_avg_C_elec_coefs2.png" />
</p>
</div>






<div class="figure">
<p><img src="../figs/tree_avg_C_elec_coefs.png" alt="tree_avg_C_elec_coefs.png" />
</p>
</div>
</div>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</div>
</div>

<div id="outline-container-org88b49f1" class="outline-3">
<h3 id="org88b49f1"><span class="section-number-3">1.12</span> Plot Coefficients from all models</h3>
<div class="outline-text-3" id="text-1-12">
<div class="org-src-container">
<pre class="src src-R">b <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tidy(C.elec.lmer.log) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(grepl(<span style="color: #2aa198;">".*tree"</span>,term)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(response = <span style="color: #2aa198;">"C.kwh.avg"</span>)
d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tidy(C.gas.lmer.log) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(grepl(<span style="color: #2aa198;">".*tree"</span>,term)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(response = <span style="color: #2aa198;">"C.gas.avg"</span>)
tree.coef <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bind_rows(b,d)

tree.coef$facet = factor(tree.coef$response, levels = c(<span style="color: #2aa198;">"kwh.avg"</span>, <span style="color: #2aa198;">"C.kwh.avg"</span>,<span style="color: #2aa198;">"therms.avg"</span>,<span style="color: #2aa198;">"C.gas.avg"</span>))
</pre>
</div>


<div class="figure">
<p><img src="../figs/tree_coefs.png" alt="tree_coefs.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-R">a <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tidy(C.avg.lmer.log) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(grepl(<span style="color: #2aa198;">".*tree"</span>,term)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(response = <span style="color: #2aa198;">"Net C emissions"</span>)
c <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tidy(C.elec.lmer.log) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(grepl(<span style="color: #2aa198;">".*tree"</span>,term)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(response = <span style="color: #2aa198;">"C from electricity"</span>)
d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tidy(C.gas.lmer.log) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(grepl(<span style="color: #2aa198;">".*tree"</span>,term)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(response = <span style="color: #2aa198;">"C from gas"</span>)

from <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"d0_0_tree"</span>,
          <span style="color: #2aa198;">"d0_20_tree"</span>,
          <span style="color: #2aa198;">"d180_0_tree"</span>,
          <span style="color: #2aa198;">"d180_20_tree"</span>,
          <span style="color: #2aa198;">"d270_0_tree"</span>,
          <span style="color: #2aa198;">"d270_20_tree"</span>,
          <span style="color: #2aa198;">"d90_0_tree"</span>,
          <span style="color: #2aa198;">"d90_20_tree"</span>)

to <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"near_north"</span>,
        <span style="color: #2aa198;">"far_north"</span>,
        <span style="color: #2aa198;">"near_south"</span>,
        <span style="color: #2aa198;">"far_south"</span>,
        <span style="color: #2aa198;">"near_west"</span>,
        <span style="color: #2aa198;">"far_west"</span>,
        <span style="color: #2aa198;">"near_east"</span>,
        <span style="color: #2aa198;">"far_east"</span>)


cc.coef <span style="color: #268bd2; font-weight: bold;">&lt;-</span> bind_rows(a,c,d)  <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(tree_location = mapvalues(term, from = from, to = to)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(percent_effect = (exp(estimate) - 1)*100,
           xmx = (exp(estimate + std.error) - 1)*100,
           xmn = (exp(estimate - std.error) - 1)*100)

                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">to get facets in correct order</span>
cc.coef$response <span style="color: #268bd2; font-weight: bold;">&lt;-</span> factor(cc.coef$response, levels=c(<span style="color: #2aa198;">"C from electricity"</span>, <span style="color: #2aa198;">"C from gas"</span>,<span style="color: #2aa198;">"Net C emissions"</span>))

</pre>
</div>


<div class="figure">
<p><img src="../figs/carbon_cost_coef.png" alt="carbon_cost_coef.png" />
</p>
</div>



<div class="figure">
<p><img src="../figs/carbon_cost_coef.png" alt="carbon_cost_coef.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/carbon_cost_Percent_coef.png" alt="carbon_cost_Percent_coef.png" />
</p>
</div>




<div class="figure">
<p><img src="../figs/carbon_cost_Percent_coef.png" alt="carbon_cost_Percent_coef.png" />
</p>
</div>


<p>
Then give the median of each response. and what the coefficients mean
for a house like that.  For example, for the median house that uses:
XX kwh, XX therms, at coefficient of .01 means a change of
</p>

<p>
bigger houses have more effect, smaller houses less effect.
</p>

<div class="org-src-container">
<pre class="src src-R">select(cc.coef, tree_location, percent_effect, response)
</pre>
</div>

<pre class="example">
   tree_location percent_effect           response
1     near_north    0.010593438    Net C emissions
2      far_north    0.011908767    Net C emissions
3     near_south    0.105619068    Net C emissions
4      far_south    0.015631832    Net C emissions
5      near_west    0.042348737    Net C emissions
6       far_west    0.045863253    Net C emissions
7      near_east    0.403341390    Net C emissions
8       far_east    0.042440220    Net C emissions
9     near_north   -0.301259281 C from electricity
10     far_north   -0.003550896 C from electricity
11    near_south   -0.394331136 C from electricity
12     far_south   -0.024271259 C from electricity
13     near_west   -0.215654401 C from electricity
14      far_west    0.021306096 C from electricity
15     near_east    0.274311399 C from electricity
16      far_east    0.023379258 C from electricity
17    near_north    0.445674445         C from gas
18     far_north    0.054805805         C from gas
19    near_south    0.812741389         C from gas
20     far_south    0.071220208         C from gas
21     near_west    0.348027756         C from gas
22      far_west    0.084072123         C from gas
23     near_east    0.682872038         C from gas
24      far_east    0.102652671         C from gas
</pre>
</div>
</div>

<div id="outline-container-org18e29b5" class="outline-3">
<h3 id="org18e29b5"><span class="section-number-3">1.13</span> plot median effect of trees maybe make this one spatial (show house in center)</h3>
<div class="outline-text-3" id="text-1-13">
<div class="org-src-container">
<pre class="src src-R">70.4/median(exp(df$log_C_gas_and_elec_Annual_avg))
70.4 / (median(exp(df$log_C_gas_Annual_avg) + median(exp(df$log_C_elec_Annual_avg))))
</pre>
</div>

<pre class="example">
[1] 0.02899636
[1] 0.02957004

</pre>

<div class="org-src-container">
<pre class="src src-R">net.coef <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   filter(cc.coef, response == <span style="color: #2aa198;">"Net C emissions"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(tree_median = t(tree_median),
           median_C =  med,
           median_treeCover_effect_kgC = (exp(estimate * tree_median) - 1) * median_C)
select(net.coef, tree_location,  median_treeCover_effect_kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> ascii.nowarn.print
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">tree<sub>location</sub></th>
<th scope="col" class="org-right">median<sub>treeCover</sub><sub>effect</sub><sub>kgC</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">near<sub>north</sub></td>
<td class="org-right">0.66</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">far<sub>north</sub></td>
<td class="org-right">3.56</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">near<sub>south</sub></td>
<td class="org-right">6.91</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">far<sub>south</sub></td>
<td class="org-right">4.66</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">near<sub>west</sub></td>
<td class="org-right">1.36</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">far<sub>west</sub></td>
<td class="org-right">7.95</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">near<sub>east</sub></td>
<td class="org-right">13.02</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">far<sub>east</sub></td>
<td class="org-right">7.31</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">poly <span style="color: #268bd2; font-weight: bold;">&lt;-</span> readWKT(<span style="color: #2aa198;">"POLYGON ((78.6 41.7, 91.3 41.7, 91.3 26.6, 78.7 26.6, 78.6 41.7))"</span>)

poly <span style="color: #268bd2; font-weight: bold;">&lt;-</span> as(poly, <span style="color: #2aa198;">"SpatialPolygonsDataFrame"</span>)
poly@data$BUILDINGFO = 0
                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">poly &lt;- build.res.primary.parcels[27940,]</span>

out <span style="color: #268bd2; font-weight: bold;">&lt;-</span> makeRegionsAroundPolygonManyAngles(poly)

out@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> out@data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(term = paste0(<span style="color: #2aa198;">"d"</span>,direction,<span style="color: #2aa198;">"_"</span>,distance.from.building,<span style="color: #2aa198;">"_tree"</span>),
                                id = 1:nrow(out@data))


med <span style="color: #268bd2; font-weight: bold;">&lt;-</span> median(exp(df$log_C_gas_and_elec_Annual_avg))

tree_median <span style="color: #268bd2; font-weight: bold;">&lt;-</span>  select(df,contains(<span style="color: #2aa198;">"tree"</span>)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    dplyr::summarize_all(median)

net.coef <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   filter(cc.coef, response == <span style="color: #2aa198;">"Net C emissions"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(tree_median = t(tree_median),
           median_C =  med,
           median_treeCover_effect_kgC = (exp(estimate * tree_median) - 1) * median_C) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(-group)

out@data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(out@data, net.coef)

o.df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> ggplot2::fortify(out)

o.df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> join(o.df,out@data, by = <span style="color: #2aa198;">"id"</span>)
</pre>
</div>

<pre class="example">
Joining, by = "term"
Regions defined for each Polygons

</pre>



<div class="figure">
<p><img src="../figs/mediantree_netC_effect_spatial.png" alt="mediantree_netC_effect_spatial.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgc604436" class="outline-3">
<h3 id="orgc604436"><span class="section-number-3">1.14</span> effect on median house</h3>
<div class="outline-text-3" id="text-1-14">
</div>
<div id="outline-container-org8793f96" class="outline-4">
<h4 id="org8793f96"><span class="section-number-4">1.14.1</span> median tree cover</h4>
<div class="outline-text-4" id="text-1-14-1">
<div class="org-src-container">
<pre class="src src-R">tree_median <span style="color: #268bd2; font-weight: bold;">&lt;-</span>  select(df,contains(<span style="color: #2aa198;">"tree"</span>)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    dplyr::summarize_all(median)
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">location</th>
<th scope="col" class="org-right">median</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">near<sub>west</sub></td>
<td class="org-right">1.8</td>
</tr>

<tr>
<td class="org-left">near<sub>south</sub></td>
<td class="org-right">3.6</td>
</tr>

<tr>
<td class="org-left">near<sub>north</sub></td>
<td class="org-right">3.4</td>
</tr>

<tr>
<td class="org-left">near<sub>east</sub></td>
<td class="org-right">1.8</td>
</tr>

<tr>
<td class="org-left">far<sub>west</sub></td>
<td class="org-right">9.6</td>
</tr>

<tr>
<td class="org-left">far<sub>south</sub></td>
<td class="org-right">16.5</td>
</tr>

<tr>
<td class="org-left">far<sub>north</sub></td>
<td class="org-right">16.6</td>
</tr>

<tr>
<td class="org-left">far<sub>east</sub></td>
<td class="org-right">9.6</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org8e25ff3" class="outline-4">
<h4 id="org8e25ff3"><span class="section-number-4">1.14.2</span> elec</h4>
<div class="outline-text-4" id="text-1-14-2">
<div class="org-src-container">
<pre class="src src-R">med <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(median(df$log_C_elec_Annual_avg))

wMedianTree <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(c$estimate * tree_median)) * med

med
wMedianTree
wMedianTree - med

pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(c$estimate * tree_median))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(c$estimate * tree_median) - 1.96 * sqrt(sum((c$std.error * tree_median)^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(c$estimate * tree_median) + 1.96 * sqrt(sum((c$std.error * tree_median)^2)/8))


<span style="color: #93a1a1;">##   </span><span style="color: #93a1a1;">pt &lt;-   exp(sum(c$estimate))</span>
<span style="color: #93a1a1;">##   </span><span style="color: #93a1a1;">lower &lt;- exp(sum(c$estimate) - 1.96 * sqrt(sum((c$std.error)^2)/8))</span>
<span style="color: #93a1a1;">##   </span><span style="color: #93a1a1;">upper &lt;- exp(sum(c$estimate) + 1.96 * sqrt(sum((c$std.error)^2)/8))</span>

pt
upper
lower * med - med
pt * med - med
upper * med - med

med

</pre>
</div>

<pre class="example">
[1] 1426.428
[1] 1392.597
[1] -33.8315
[1] 0.9762824
[1] 0.989685
[1] -52.69042
[1] -33.8315
[1] -14.71368
[1] 1426.428

</pre>


<pre class="example">
[1] 1083.793 - median annual kg C emissions from electric
[1] -6.778448 - if 100m^2 tree cover added to each region, would decrease by
[1] -33.47093 - if 500m^2 tree cover added to each region, would decrease by

</pre>
</div>
</div>
<div id="outline-container-orgfbb188a" class="outline-4">
<h4 id="orgfbb188a"><span class="section-number-4">1.14.3</span> gas</h4>
<div class="outline-text-4" id="text-1-14-3">
<p>
Assume 100m<sup>2</sup> in each region:
</p>

<div class="org-src-container">
<pre class="src src-R">med <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(median(df$log_C_gas_Annual_avg))
w100tree <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(d$estimate)) * exp(median(df$log_C_gas_Annual_avg))

pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(d$estimate * tree_median))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(d$estimate * tree_median) - 1.96 * sqrt(sum((d$std.error * tree_median)^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(d$estimate * tree_median) + 1.96 * sqrt(sum((d$std.error * tree_median)^2)/8))

lower
pt
upper
med
lower * med - med
pt * med - med
upper * med - med

</pre>
</div>

<pre class="example">
[1] 1.097307
[1] 1.107179
[1] 1.11714
[1] 954.36
[1] 92.86634
[1] 102.2876
[1] 111.7937

</pre>
<p>
C from gas use goes up 24 kg.
</p>


<p>
if 5 100m<sup>2</sup> trees in each region (pretty darn forested)
</p>
<div class="org-src-container">
<pre class="src src-R">
w500tree <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(5*d$estimate)) * exp(median(df$log_C_gas_Annual_avg))
w500tree - med
</pre>
</div>

<pre class="example">
[1] 132.2063

</pre>

<p>
C from gas use goes up 127.5 kg. ish.
</p>
</div>
</div>

<div id="outline-container-org2ce96a7" class="outline-4">
<h4 id="org2ce96a7"><span class="section-number-4">1.14.4</span> gas and elec</h4>
<div class="outline-text-4" id="text-1-14-4">
<p>
Using the estimates from above, just adding the separate effects
together:
median C is 2037
effect of 100m<sup>2</sup> in each region is 24.2 + (-6.8) = 17.4 kg
effect of 500m<sup>2</sup> in each region is 127.5 + (-33.5) = 94 kg
</p>

<p>
median house
</p>
<div class="org-src-container">
<pre class="src src-R">med <span style="color: #268bd2; font-weight: bold;">&lt;-</span> median(exp(df$log_C_gas_and_elec_Annual_avg))

pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(a$estimate * tree_median))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate * tree_median) - 1.96 * sqrt(sum((a$std.error * tree_median)^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate * tree_median) + 1.96 * sqrt(sum((a$std.error * tree_median)^2)/8))

lower
pt
upper
med
lower * med - med
pt* med - med
upper * med - med
(pt* med - med)/med
</pre>
</div>

<pre class="example">
[1] 1.015937
[1] 1.025497
[1] 1.035148
[1] 2427.891
[1] 38.69391
[1] 61.90511
[1] 85.33472
[1] 0.02549748

</pre>

<p>
These results are pretty close to the combined separate effects as one
would expect
</p>

<p>
mean
</p>
<div class="org-src-container">
<pre class="src src-R">tree_mean <span style="color: #268bd2; font-weight: bold;">&lt;-</span>  select(df,contains(<span style="color: #2aa198;">"tree"</span>)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    dplyr::summarize_all(mean)

mn <span style="color: #268bd2; font-weight: bold;">&lt;-</span> mean(exp(df$log_C_gas_and_elec_Annual_avg))

pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(a$estimate * tree_mean))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate * tree_mean) - 1.96 * sqrt(sum((a$std.error * tree_mean)^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate * tree_mean) + 1.96 * sqrt(sum((a$std.error * tree_mean)^2)/8))

lower * mn - mn
pt* mn - mn
upper * mn - mn


(pt* mn - mn) / mn
</pre>
</div>

<pre class="example">
[1] 42.85785
[1] 68.11191
[1] 93.60924
[1] 0.02641134

</pre>

<p>
median 100m<sup>2</sup>
</p>

<div class="org-src-container">
<pre class="src src-R">med <span style="color: #268bd2; font-weight: bold;">&lt;-</span> median(exp(df$log_C_gas_and_elec_Annual_avg))

pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(a$estimate))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate) - 1.96 * sqrt(sum((a$std.error)^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate) + 1.96 * sqrt(sum((a$std.error)^2)/8))

lower
pt
upper
med
lower * med - med
pt* med - med
upper * med - med
(pt* med - med)/med
</pre>
</div>

<pre class="example">
[1] 1.004521
[1] 1.006791
[1] 1.009067
[1] 2427.891
[1] 10.97564
[1] 16.48889
[1] 22.01461
[1] 0.006791446

</pre>

<p>
median 100m<sup>2</sup>  near
</p>

<div class="org-src-container">
<pre class="src src-R">med <span style="color: #268bd2; font-weight: bold;">&lt;-</span> median(exp(df$log_C_gas_and_elec_Annual_avg))

pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(a$estimate[c(1,3,5,7)]))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate[c(1,3,5,7)]) - 1.96 * sqrt(sum((a$std.error[c(1,3,5,7)])^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate[c(1,3,5,7)]) + 1.96 * sqrt(sum((a$std.error[c(1,3,5,7)])^2)/8))

lower
pt
upper
med
lower * med - med
pt* med - med
upper * med - med
(pt* med - med)/med
</pre>
</div>

<pre class="example">
[1] 1.003448
[1] 1.005626
[1] 1.007809
[1] 2427.891
[1] 8.371475
[1] 13.65938
[1] 18.95877
[1] 0.005626028

</pre>


<p>
near<sub>east</sub> is 7
</p>
<div class="org-src-container">
<pre class="src src-R">pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(a$estimate[7]))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate[7]) - 1.96 * sqrt(sum((a$std.error[7])^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate[7]) + 1.96 * sqrt(sum((a$std.error[7])^2)/8))

med
lower * med - med
pt* med - med
upper * med - med

</pre>
</div>

<pre class="example">
[1] 2427.891
[1] 6.730497
[1] 9.79269
[1] 12.85873

</pre>

<p>
near<sub>west</sub> is 5
</p>
<div class="org-src-container">
<pre class="src src-R">pt <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   exp(sum(a$estimate[5]))
lower <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate[5]) - 1.96 * sqrt(sum((a$std.error[5])^2)/8))
upper <span style="color: #268bd2; font-weight: bold;">&lt;-</span> exp(sum(a$estimate[5]) + 1.96 * sqrt(sum((a$std.error[5])^2)/8))

med
lower * med - med
pt* med - med
upper * med - med

</pre>
</div>

<pre class="example">
[1] 2427.891
[1] -2.075
[1] 1.028181
[1] 4.135332

</pre>
</div>
</div>
</div>

<div id="outline-container-orgff0bef3" class="outline-3">
<h3 id="orgff0bef3"><span class="section-number-3">1.15</span> Comparing C emissions from energy use due to trees to C stored and sequestered.</h3>
<div class="outline-text-3" id="text-1-15">
</div>
<div id="outline-container-org9339eee" class="outline-4">
<h4 id="org9339eee"><span class="section-number-4">1.15.1</span> Consider a green ash tree that grows at .61 cm per year.</h4>
<div class="outline-text-4" id="text-1-15-1">
<p>
that growth rate is from : <a href="http://www.sciencedirect.com/science/article/pii/S0269749101002147">http://www.sciencedirect.com/science/article/pii/S0269749101002147</a>
</p>

<p>
equations are from <a href="https://www.fs.usda.gov/rds/archive/Product/RDS-2016-0005">https://www.fs.usda.gov/rds/archive/Product/RDS-2016-0005</a>
</p>


<p>
The coefficients of models are for 100m<sup>2</sup> of tree canopy cover.
</p>

<div class="org-src-container">
<pre class="src src-R">eqn <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">"../RD/RDS-2016-0005/Data/TS6_Growth_coefficients.csv"</span>, stringsAsFactors = F) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(a = as.numeric(a))

                                        <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">uni &lt;- eqn %&gt;% select(Region, Scientific.Name) %&gt;% unique</span>

                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">fix the coefficents in rows 143, 150, 213.  see email with natalie</span>
eqn[is.na(as.numeric(eqn$a)),9:11] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> eqn[is.na(as.numeric(eqn$a)),10:12]

eqn <span style="color: #268bd2; font-weight: bold;">&lt;-</span> eqn <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(Region <span style="color: #268bd2; font-weight: bold;">%in%</span> c(<span style="color: #2aa198;">"MidWst"</span>), Scientific.Name == <span style="color: #2aa198;">"Fraxinus pennsylvanica"</span>, Independent.variable == <span style="color: #2aa198;">"cdia"</span>)
eqn
</pre>
</div>

<pre class="example">
Warning message:
In evalq(as.numeric(a), &lt;environment&gt;) : NAs introduced by coercion
  Region        Scientific.Name SpCode Independent.variable Predicts.component
1 MidWst Fraxinus pennsylvanica   FRPE                 cdia                dbh
  Units.of.predicted.components Model.weight EqName       a        b       c
1                        meters     1/cdia^2    cub 5.37282 -0.59669 0.69285
         d  e Apps.min Apps.max   Sigma  n adj.R2 Data.min..from.raw.data.
1 -0.02238 NA     1.99       88 0.99473 46  0.912                      5.8
  Data.max..from.raw.data. DF
1                    107.2 42
</pre>

<p>
A tree that has a circular crown with an area of 100m<sup>2</sup> would have a
diameter of
</p>
<div class="org-src-container">
<pre class="src src-R">cdia <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 2 * sqrt(100/pi)
cdia
</pre>
</div>

<pre class="example">
[1] 11.28379

</pre>

<p>
Estimate dbh of such a tree
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">attach</span>(eqn)
dbh <span style="color: #268bd2; font-weight: bold;">&lt;-</span> a + b * cdia + c * cdia^2 + d * cdia^3
<span style="color: #268bd2; font-weight: bold;">detach</span>(eqn)
dbh
</pre>
</div>

<pre class="example">
The following objects are masked _by_ .GlobalEnv:

    a, b, c, d

The following objects are masked from eqn (pos = 3):

    a, adj.R2, Apps.max, Apps.min, b, c, d, Data.max..from.raw.data.,
    Data.min..from.raw.data., DF, e, EqName, Independent.variable,
    Model.weight, n, Predicts.component, Region, Scientific.Name,
    Sigma, SpCode, Units.of.predicted.components
Error in FUN(left, right) : non-numeric argument to binary operator
[1] 54.70302
</pre>


<p>
Now to calculate Volume
</p>

<p>
Equation Species,DBH lower (cm),DBH upper (cm),Equation,Predicts,DW Density,Equation Source
Fraxinus pennsylvanica,15,123, = 0.0005885*dbhcm<sup>2.206,Volume,530,McHale</sup> 2007
</p>

<p>
units are m<sup>3</sup>
vol<sub>y1</sub> = volume this year
vol<sub>y2</sub> = volume after a year of growth.
</p>
<div class="org-src-container">
<pre class="src src-R">vol_y1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.0005885*dbh^2.206
vol_y2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.0005885*(dbh+.61)^2.206

vol_y1
vol_y2
</pre>
</div>

<pre class="example">
[1] 4.016052
[1] 4.11551

</pre>

<p>
Calculate above ground Dry Weight 530 kg / m<sup>3</sup>
</p>
<div class="org-src-container">
<pre class="src src-R">dw1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> vol_y1 * 530
dw2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> vol_y2 * 530
dw1
dw2
</pre>
</div>

<pre class="example">
[1] 2128.508
[1] 2181.22

</pre>

<p>
pg 79 of
<a href="https://www.fs.fed.us/psw/publications/documents/psw_gtr253/psw_gtr_253.pdf">https://www.fs.fed.us/psw/publications/documents/psw_gtr253/psw_gtr_253.pdf</a>,
shows the below ground correction to get total dry weight is to
multiply above ground by 1.28
</p>

<p>
Then divide by 2 to convert dry weight into carbon.
</p>

<div class="org-src-container">
<pre class="src src-R">C1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> dw1 * 1.28 / 2
C2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> dw2 * 1.28 /2
C1
C2
Cseq <span style="color: #268bd2; font-weight: bold;">&lt;-</span> C2-C1
Cseq
</pre>
</div>

<pre class="example">
[1] 1362.245
[1] 1395.981
[1] 33.73587

</pre>

<p>
so almost 34 kg carbon are sequestered in a year by a ash tree with a
canopy of 100m<sup>2</sup>.
</p>
</div>
</div>
</div>
<div id="outline-container-orgf2e5f2a" class="outline-3">
<h3 id="orgf2e5f2a"><span class="section-number-3">1.16</span> tree distributions</h3>
<div class="outline-text-3" id="text-1-16">

<div class="figure">
<p><img src="../figs/tree_distr.png" alt="tree_distr.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org8e2898f" class="outline-2">
<h2 id="org8e2898f"><span class="section-number-2">2</span> extending old papers</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org22d63f6" class="outline-3">
<h3 id="org22d63f6"><span class="section-number-3">2.1</span> extending <a class='org-ref-reference' href="#thayer_maeda_1985">thayer_maeda_1985</a></h3>
<div class="outline-text-3" id="text-2-1">
<p>
How much C emissions do these trees cause or prevent?
Annual
</p>
<div class="org-src-container">
<pre class="src src-R" id="orge48c1f1"><span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)

data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">'../RD/thayer_maeda_table3.csv'</span>)

therm.cost <span style="color: #268bd2; font-weight: bold;">&lt;-</span> .56
kgC.perThermNaturalGas <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1.446
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">The carbon coefficient for natural gas is 1.446 kg C / therm citep:epa_a2_2017.</span>

Ctherms <span style="color: #268bd2; font-weight: bold;">&lt;-</span>    data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(Heating.Cooling == <span style="color: #2aa198;">"Heating"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(therms = Cost / therm.cost) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(-Cost, Heating.Cooling) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(City) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(Condition, therms) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(therms_dueToTrees = Trees - NoTrees) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(City, therms_dueToTrees) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC_fromTherms_dueToTrees = therms_dueToTrees * kgC.perThermNaturalGas) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    data.frame

Ctherms
</pre>
</div>

<pre class="example">
          City therms_dueToTrees kgC_fromTherms_dueToTrees
1       Eureka          64.26786                  92.93132
2  PalmSprings           9.75000                  14.09850
3   Sacramento          25.17857                  36.40821
4 SantaBarbara          30.98214                  44.80018
5      Truckee          68.55357                  99.12846

</pre>

<div class="org-src-container">
<pre class="src src-R" id="org5a48ba0">
<span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)

kwh.cost <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.07
kgC.perkwh <span style="color: #268bd2; font-weight: bold;">&lt;-</span> .1567988
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">.1567988 kg C / kWh  THis is from Wisconsin.</span>

Ckwh <span style="color: #268bd2; font-weight: bold;">&lt;-</span>    data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(Heating.Cooling == <span style="color: #2aa198;">"Cooling"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kwh = Cost / kwh.cost) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(-Cost, Heating.Cooling) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(City) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(Condition, kwh) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kwh_dueToTrees = Trees - NoTrees) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(City, kwh_dueToTrees) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC_fromKwh_dueToTrees = kwh_dueToTrees * kgC.perkwh) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    data.frame

Ckwh
</pre>
</div>

<pre class="example">
          City kwh_dueToTrees kgC_fromKwh_dueToTrees
1       Eureka        0.00000               0.000000
2  PalmSprings     -934.42857            -146.517279
3   Sacramento     -432.85714             -67.871481
4 SantaBarbara      -24.42857              -3.830371
5      Truckee        0.00000               0.000000

</pre>

<p>
Two figures:
</p>
<ol class="org-ol">
<li>bar chart with C on y axis, City on X axis, 3 bars for each city
for heating, cooling, and net.</li>
<li>plot cities in HDD and CDD space, color the dot by the net C.</li>
</ol>

<div class="org-src-container">
<pre class="src src-R">
Ccooling <span style="color: #268bd2; font-weight: bold;">&lt;-</span> Ckwh <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = kgC_fromKwh_dueToTrees,
           hc = <span style="color: #2aa198;">"cooling"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(-kwh_dueToTrees, -kgC_fromKwh_dueToTrees)

Cheating <span style="color: #268bd2; font-weight: bold;">&lt;-</span> Ctherms <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = kgC_fromTherms_dueToTrees,
           hc = <span style="color: #2aa198;">"heating"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(-therms_dueToTrees, -kgC_fromTherms_dueToTrees)

C <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(Cheating, Ccooling) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    ungroup() <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(hc, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(net = heating + cooling) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    gather(hc, C, -City)
C

</pre>
</div>

<pre class="example">
           City      hc           C
1        Eureka cooling    0.000000
2   PalmSprings cooling -146.517279
3    Sacramento cooling  -67.871481
4  SantaBarbara cooling   -3.830371
5       Truckee cooling    0.000000
6        Eureka heating   92.931321
7   PalmSprings heating   14.098500
8    Sacramento heating   36.408214
9  SantaBarbara heating   44.800179
10      Truckee heating   99.128464
11       Eureka     net   92.931321
12  PalmSprings     net -132.418779
13   Sacramento     net  -31.463266
14 SantaBarbara     net   40.969808
15      Truckee     net   99.128464
</pre>

<div class="figure">
<p><img src="../figs/thayer_maeda_bar.png" alt="thayer_maeda_bar.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-R">clim <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">"../RD/thayer_maeda_fig7_city_hdd_cdd.csv"</span>)

clim <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(filter(C, hc == <span style="color: #2aa198;">"net"</span>), clim)
clim
</pre>
</div>

<pre class="example">
Joining, by = "City"
          City  hc          C  HDD  CDD
1       Eureka net   92.93132 4679    0
2  PalmSprings net -132.41878 1240 3681
3   Sacramento net  -31.46327 2849 1159
4 SantaBarbara net   40.96981 2110  386
5      Truckee net   99.12846 8208   33

</pre>


<div class="figure">
<p><img src="../figs/city_hddcddspace.png" alt="city_hddcddspace.png" />
</p>
</div>

<p>
Trees can have the strongest effect in hot climates (maybe why we
study those places a lot), but those aren't where most people live.
</p>
</div>
</div>

<div id="outline-container-org1fe1a04" class="outline-3">
<h3 id="org1fe1a04"><span class="section-number-3">2.2</span> extending <a class='org-ref-reference' href="#mcpherson_e_1988">mcpherson_e_1988</a></h3>
<div class="outline-text-3" id="text-2-2">
<p>
Note that they don't try to give a full summary of the effects of
trees on building energy use and note that they need to include
temperature humidity etc.
</p>

<p>
Taking their data, converting to C, Madison does have a small
increase, like i found
</p>
</div>

<div id="outline-container-org1624999" class="outline-4">
<h4 id="org1624999"><span class="section-number-4">2.2.1</span> Libraries</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(ggplot2)
<span style="color: #268bd2; font-weight: bold;">library</span>(zoo)
<span style="color: #268bd2; font-weight: bold;">library</span>(ggthemes)
</pre>
</div>
</div>
</div>

<div id="outline-container-org334db03" class="outline-4">
<h4 id="org334db03"><span class="section-number-4">2.2.2</span> costs and carbon emission rates</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
Costs of energy in paper, pg 43
</p>

<p>
Emission Rates for each city from PowerProfiler from EPA.  The 2016
excel workbook came from Johnson.Travis@epa.gov.  It's also available
online (2016 version will be soon) at
<a href="https://www.epa.gov/energy/power-profiler">https://www.epa.gov/energy/power-profiler</a>.  Rates provided in lbs/
mwh.  I convert them below.
</p>

<p>
The assumption that they all use natural gas for heating may not
reflect the reality across the country, but I think that was how the
paper modeled things. for what it's worth.
</p>

<div class="org-src-container">
<pre class="src src-R">therm.cost <span style="color: #268bd2; font-weight: bold;">&lt;-</span> .6  <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">the price of fuel was assumed to be $0.60 per therm.</span>
kwh.cost <span style="color: #268bd2; font-weight: bold;">&lt;-</span> .08 <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Electric power prices were $0.08 per kilowatt hour.</span>

kgC.perThermNaturalGas <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1.446
                                        <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">1 lb = 0.453592 kg</span>
                                        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">12 kg C / 44 kg CO2</span>

<span style="color: #268bd2;">lbCO2mwhTOkgCkwh</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(lbmwh) {lbmwh * 0.453592 / 1000 * 12 / 44}

City <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"Madison"</span>, <span style="color: #2aa198;">"SaltLakeCity"</span>, <span style="color: #2aa198;">"Tucson"</span>, <span style="color: #2aa198;">"Miami"</span>)
lbCO2.perMWH <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"Madison"</span> = 1668.212, <span style="color: #2aa198;">"SaltLakeCity"</span> = 651.199, <span style="color: #2aa198;">"Tucson"</span> = 1043.645, <span style="color: #2aa198;">"Miami"</span> = 1011.683)
kgC.perkwh <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lbCO2mwhTOkgCkwh(lbCO2.perMWH)

emission.rate <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data.frame(City, kgC.perkwh)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgce68412" class="outline-4">
<h4 id="orgce68412"><span class="section-number-4">2.2.3</span> Figure 3. solar irradiance.</h4>
<div class="outline-text-4" id="text-2-2-3">
<table id="orgafab48d" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">City</th>
<th scope="col" class="org-left">Surfaces</th>
<th scope="col" class="org-left">HC</th>
<th scope="col" class="org-right">ShadeFactor</th>
<th scope="col" class="org-right">Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Madison</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">0</td>
<td class="org-right">84</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">1</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">0</td>
<td class="org-right">616</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">1</td>
<td class="org-right">776</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">0</td>
<td class="org-right">258</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">1</td>
<td class="org-right">60</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">0</td>
<td class="org-right">470</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">1</td>
<td class="org-right">620</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">0</td>
<td class="org-right">472</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">1</td>
<td class="org-right">168</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">0</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">1</td>
<td class="org-right">19</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">0</td>
<td class="org-right">438</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-left">all</td>
<td class="org-left">cooling</td>
<td class="org-right">1</td>
<td class="org-right">150</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">0</td>
<td class="org-right">114</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-left">all</td>
<td class="org-left">heating</td>
<td class="org-right">1</td>
<td class="org-right">190</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">shade.data.tot <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shade.data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(City, Surfaces, ShadeFactor) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    summarize(Cost = sum(Cost)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(HC = <span style="color: #2aa198;">"total"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> data.frame
shade.data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(shade.data, shade.data.tot)
</pre>
</div>


<div class="figure">
<p><img src="../figs/mcpherson_1988_fig2_dollars.png" alt="mcpherson_1988_fig2_dollars.png" />
</p>
</div>

<p>
Looking at cost in dollars, only in Madison do trees cause increase
emissions.  Trees increase heating costs, but the decrease in cooling
costs is greater for 3 of the 4 cities.  Shading from trees can cause
very large large decreases in cost in hot places like Miami.
</p>

<div class="org-src-container">
<pre class="src src-R">heating <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(HC == <span style="color: #2aa198;">"heating"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = Cost / therm.cost * kgC.perThermNaturalGas)

data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(data, emission.rate)
cooling <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(HC == <span style="color: #2aa198;">"cooling"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = Cost / kwh.cost * kgC.perkwh)

sf <span style="color: #268bd2; font-weight: bold;">&lt;-</span> expand.grid(<span style="color: #2aa198;">"City"</span> = c(<span style="color: #2aa198;">"Madison"</span>,<span style="color: #2aa198;">"Tucson"</span>,<span style="color: #2aa198;">"SaltLakeCity"</span>,<span style="color: #2aa198;">"Miami"</span>), <span style="color: #2aa198;">"ShadeFactor"</span> = seq(0,1,.1), <span style="color: #2aa198;">"HC"</span> = c(<span style="color: #2aa198;">"cooling"</span>, <span style="color: #2aa198;">"heating"</span>), <span style="color: #2aa198;">"Surfaces"</span> = <span style="color: #2aa198;">"all"</span>)

cool <span style="color: #268bd2; font-weight: bold;">&lt;-</span> select(cooling, City, ShadeFactor, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> rename(cooling = kgC)
heat <span style="color: #268bd2; font-weight: bold;">&lt;-</span> select(heating, City, ShadeFactor, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> rename(heating = kgC)
shade.data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(cool, heat) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    gather(HC, kgC, -City, -ShadeFactor) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    left_join(sf, .) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    arrange(City, HC, ShadeFactor) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = na.approx(kgC)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    data.frame

shade.data.tot <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shade.data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(City, Surfaces, ShadeFactor) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    summarize(kgC = sum(kgC)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(HC = <span style="color: #2aa198;">"total"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> data.frame
shade.data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(shade.data, shade.data.tot)
</pre>
</div>


<div class="figure">
<p><img src="../figs/mcpherson_1988_fig2_carbon.png" alt="mcpherson_1988_fig2_carbon.png" />
</p>
</div>

<p>
When cost is converted to kg C, now shading causes increase in
emissions for 2 of the 4 cities.  Decrease in hot climates is still
larger than increase in cold climates, but less so.  This is because
of the different cost of Carbon in heating (gas) versus cooling
(electric).  See Table <a href="#org89668a6">1</a>.
</p>
</div>
</div>

<div id="outline-container-org6043b80" class="outline-4">
<h4 id="org6043b80"><span class="section-number-4">2.2.4</span> figure 4, wind</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
I estimated these values by looking at the figure.
</p>
<table id="orge7d43e3" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">City</th>
<th scope="col" class="org-right">WCF</th>
<th scope="col" class="org-left">HC</th>
<th scope="col" class="org-right">Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Madison</td>
<td class="org-right">0</td>
<td class="org-left">heating</td>
<td class="org-right">590</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-right">1</td>
<td class="org-left">heating</td>
<td class="org-right">616</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">0</td>
<td class="org-left">heating</td>
<td class="org-right">375</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">1</td>
<td class="org-left">heating</td>
<td class="org-right">447</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">0</td>
<td class="org-left">heating</td>
<td class="org-right">75</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">1</td>
<td class="org-left">heating</td>
<td class="org-right">95</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">0</td>
<td class="org-left">heating</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">1</td>
<td class="org-left">heating</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-right">0</td>
<td class="org-left">cooling</td>
<td class="org-right">150</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-right">.25</td>
<td class="org-left">cooling</td>
<td class="org-right">85</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-right">.5</td>
<td class="org-left">cooling</td>
<td class="org-right">66</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-right">.75</td>
<td class="org-left">cooling</td>
<td class="org-right">64</td>
</tr>

<tr>
<td class="org-left">Madison</td>
<td class="org-right">1</td>
<td class="org-left">cooling</td>
<td class="org-right">62</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">0</td>
<td class="org-left">cooling</td>
<td class="org-right">325</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">.25</td>
<td class="org-left">cooling</td>
<td class="org-right">245</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">.5</td>
<td class="org-left">cooling</td>
<td class="org-right">217</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">.75</td>
<td class="org-left">cooling</td>
<td class="org-right">205</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">1</td>
<td class="org-left">cooling</td>
<td class="org-right">200</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">0</td>
<td class="org-left">cooling</td>
<td class="org-right">525</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">.25</td>
<td class="org-left">cooling</td>
<td class="org-right">433</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">.5</td>
<td class="org-left">cooling</td>
<td class="org-right">375</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">.75</td>
<td class="org-left">cooling</td>
<td class="org-right">350</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">1</td>
<td class="org-left">cooling</td>
<td class="org-right">342</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">0</td>
<td class="org-left">cooling</td>
<td class="org-right">570</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">.25</td>
<td class="org-left">cooling</td>
<td class="org-right">470</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">.5</td>
<td class="org-left">cooling</td>
<td class="org-right">425</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">.75</td>
<td class="org-left">cooling</td>
<td class="org-right">395</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">1</td>
<td class="org-left">cooling</td>
<td class="org-right">385</td>
</tr>
</tbody>
</table>


<div class="figure">
<p><img src="../figs/mcpherson_1988_fig4.png" alt="mcpherson_1988_fig4.png" />
</p>
</div>


<div class="org-src-container">
<pre class="src src-R">heating <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(HC == <span style="color: #2aa198;">"heating"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = Cost / therm.cost * kgC.perThermNaturalGas)

data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(data, emission.rate)

cooling <span style="color: #268bd2; font-weight: bold;">&lt;-</span>   data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(HC == <span style="color: #2aa198;">"cooling"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = Cost / kwh.cost * kgC.perkwh)

</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">cool <span style="color: #268bd2; font-weight: bold;">&lt;-</span> select(cooling, City, WCF, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> rename(cooling = kgC)
heat <span style="color: #268bd2; font-weight: bold;">&lt;-</span> select(heating, City, WCF, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> rename(heating = kgC)
wind.data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(cool, heat) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(heating = na.approx(heating)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(City, WCF) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    gather(HC, kgC, -City, -WCF) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    data.frame

wind.data.tot <span style="color: #268bd2; font-weight: bold;">&lt;-</span> wind.data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(City, WCF) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    summarize(kgC = sum(kgC)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(HC = <span style="color: #2aa198;">"total"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> data.frame
wind.data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(wind.data, wind.data.tot)

</pre>
</div>


<div class="figure">
<p><img src="../figs/mcpherson_1988_fig4_carbon_stacked.png" alt="mcpherson_1988_fig4_carbon_stacked.png" />
</p>
</div>

<p>
The qualitative difference in the trend lines is mostly in Salt Lake
where the maximum emissions occur with wind.  This is opposite all
other cities.  (Though the wind effect really is pretty small in Salt
Lake).
</p>

<p>
As seen in figure 3 too, the colder places emit much more than the
warmer places, although the amount they spend isn't too much
different.
</p>


<p>
The result is that for Madison full wind is almost the minimum now.
For Salt Lake there is very little difference. This suggests that for
wind, the summer effect is stronger than the winter effect for all
cities.
</p>

<p>
In fig 4, where $ is y axis, full wind is higher than no wind for
Madison, but this not the case for Carbon.
</p>

<p>
The key takeaway is that when C is the unit of interest (not cost)
then wind reduction almost always increases emissions.
</p>
</div>
</div>

<div id="outline-container-org7a09635" class="outline-4">
<h4 id="org7a09635"><span class="section-number-4">2.2.5</span> combine shade with wind for what they describe as tree conditions.</h4>
<div class="outline-text-4" id="text-2-2-5">
<p>
versus none.
</p>

<p>
No tree and .75 wind (assume buildings reduce some of the wind)
compared to .25 wind, .8 shade cooling and .4 shade heating (full
deciduous tree cover).
</p>

<p>
the shading was done assuming wind was .25
the wind was done assuming no shade.
</p>

<div class="org-src-container">
<pre class="src src-R">shading <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shade.data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter((ShadeFactor <span style="color: #268bd2; font-weight: bold;">%in%</span> c(0, .8) &amp; HC == <span style="color: #2aa198;">"cooling"</span>) | (ShadeFactor <span style="color: #268bd2; font-weight: bold;">%in%</span> c(0, .4) &amp; HC == <span style="color: #2aa198;">"heating"</span>)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(DeciduousTree = ShadeFactor != 0) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(-ShadeFactor, -Surfaces) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(DeciduousTree, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(shade.effect = <span style="color: #657b83; background-color: #fdf6e3;">`TRUE`</span> -<span style="color: #657b83; background-color: #fdf6e3;">`FALSE`</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(City, HC, shade.effect)

winding <span style="color: #268bd2; font-weight: bold;">&lt;-</span> wind.data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(WCF <span style="color: #268bd2; font-weight: bold;">%in%</span> c(.25, 1)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(WCF, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(wind.effect = <span style="color: #657b83; background-color: #fdf6e3;">`0.25`</span> - <span style="color: #657b83; background-color: #fdf6e3;">`1`</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(City, HC, wind.effect)

df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(shading, winding) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(shade_and_wind.effect = shade.effect + wind.effect) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    gather(effect, kgC, -City, -HC)
</pre>
</div>

<pre class="example">
Joining, by = c("City", "HC")

</pre>


<div class="figure">
<p><img src="../figs/mcpherson_1988_shadewind_effects.png" alt="mcpherson_1988_shadewind_effects.png" />
</p>
</div>

<p>
for all 4 cities:
</p>
<ul class="org-ul">
<li>shading reduces cooling related emissions, increases heating related
emissions, the reduction is always greater than the increase.</li>
<li>The wind reduction from trees increases cooling related emissions,
decreases heating related.  The increase is greater than the
decrease in all cities except Salt Lake.</li>
</ul>

<div class="org-src-container">
<pre class="src src-R">df.sumHeatCool <span style="color: #268bd2; font-weight: bold;">&lt;-</span> df <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(City, effect) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    summarize(kgC = sum(kgC))
</pre>
</div>


<div class="figure">
<p><img src="../figs/mcpherson_1988_shadewind_effects_sumHeatCool.png" alt="mcpherson_1988_shadewind_effects_sumHeatCool.png" />
</p>
</div>

<p>
Trees overall decrease carbon emissions (according to their scenario
and assumptions).  For 3 of 4 cities, the shading causes a net
decrease in emissions and for 3 of 4 cities, the wind reduction causes
a net increase in emissions.
</p>

<p>
It's really pretty interesting in that it is complex.  For the warm
cities, wind reduction increases emissions and shading decreases
emissions.  For Madison, both shading and wind reduction increase
emissions a little.  For Salt Lake, both shading and wind reduction
decrease emissions a little.
</p>

<table id="org89668a6" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">$ / kgC</th>
<th scope="col" class="org-left">HC</th>
<th scope="col" class="org-left">where</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">.4149</td>
<td class="org-left">heating</td>
<td class="org-left">all</td>
</tr>

<tr>
<td class="org-right">.3876</td>
<td class="org-left">cooling</td>
<td class="org-left">Miami</td>
</tr>

<tr>
<td class="org-right">.9931</td>
<td class="org-left">cooling</td>
<td class="org-left">Tucson</td>
</tr>

<tr>
<td class="org-right">.6196</td>
<td class="org-left">cooling</td>
<td class="org-left">SaltLakeCity</td>
</tr>

<tr>
<td class="org-right">.6392</td>
<td class="org-left">cooling</td>
<td class="org-left">Madison</td>
</tr>
</tbody>
</table>

<p>
For every dollar of electric you buy your emitting less C than for
every dollar of Gas you buy.
</p>

<p>
Becuase C is more expensive
</p>

<div class="org-src-container">
<pre class="src src-R">.6 / 1.446
</pre>
</div>

<pre class="example">
[1] 0.4149378

</pre>

<div class="org-src-container">
<pre class="src src-R">.08 / kgC.perkwh
</pre>
</div>

<pre class="example">
  Madison SaltLakeCity       Tucson        Miami
0.3876545    0.9930756    0.6196454    0.6392218

</pre>
</div>
</div>


<div id="outline-container-orgeaaa269" class="outline-4">
<h4 id="orgeaaa269"><span class="section-number-4">2.2.6</span> HDD and CDD space</h4>
<div class="outline-text-4" id="text-2-2-6">
<table id="org41ec784" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">City</th>
<th scope="col" class="org-right">HDD</th>
<th scope="col" class="org-right">CDD</th>
<th scope="col" class="org-right">Wind vel.</th>
<th scope="col" class="org-right">Cloud Cover</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Madison</td>
<td class="org-right">7373</td>
<td class="org-right">557</td>
<td class="org-right">4.4</td>
<td class="org-right">5.5</td>
</tr>

<tr>
<td class="org-left">SaltLakeCity</td>
<td class="org-right">5993</td>
<td class="org-right">1012</td>
<td class="org-right">4.0</td>
<td class="org-right">4.4</td>
</tr>

<tr>
<td class="org-left">Tucson</td>
<td class="org-right">1680</td>
<td class="org-right">2822</td>
<td class="org-right">3.9</td>
<td class="org-right">2.4</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-right">182</td>
<td class="org-right">3973</td>
<td class="org-right">3.9</td>
<td class="org-right">5.4</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(df.sumHeatCool, clim)
d <span style="color: #268bd2; font-weight: bold;">&lt;-</span> d <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(effect == <span style="color: #2aa198;">"shade_and_wind.effect"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>data.frame
</pre>
</div>

<pre class="example">
Joining, by = "City"

</pre>


<div class="figure">
<p><img src="../figs/mcpherson_1988_city_hddcddspace.png" alt="mcpherson_1988_city_hddcddspace.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org3744436" class="outline-3">
<h3 id="org3744436"><span class="section-number-3">2.3</span> extending <a class='org-ref-reference' href="#huang_e_1990">huang_e_1990</a></h3>
<div class="outline-text-3" id="text-2-3">
<p>
1980s house
</p>

<p>
Heating is MBtu
Cooling is kWh
</p>

<table id="org3766c61" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">City</th>
<th scope="col" class="org-left">HC</th>
<th scope="col" class="org-right">Base</th>
<th scope="col" class="org-right">delta<sub>Wind</sub><sub>30pctCvr</sub></th>
<th scope="col" class="org-right">delta<sub>WindAndShade</sub><sub>30pctCvr</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Chicago</td>
<td class="org-left">Heating</td>
<td class="org-right">107.6</td>
<td class="org-right">-15.6</td>
<td class="org-right">-11.7</td>
</tr>

<tr>
<td class="org-left">Chicago</td>
<td class="org-left">Cooling</td>
<td class="org-right">2126</td>
<td class="org-right">-9</td>
<td class="org-right">-394</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-left">Heating</td>
<td class="org-right">3.7</td>
<td class="org-right">-0.4</td>
<td class="org-right">-0.2</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-left">Cooling</td>
<td class="org-right">8658</td>
<td class="org-right">-390</td>
<td class="org-right">-1365</td>
</tr>

<tr>
<td class="org-left">Minneapolis</td>
<td class="org-left">Heating</td>
<td class="org-right">97.1</td>
<td class="org-right">-9.5</td>
<td class="org-right">-5.9</td>
</tr>

<tr>
<td class="org-left">Minneapolis</td>
<td class="org-left">Cooling</td>
<td class="org-right">1543</td>
<td class="org-right">30</td>
<td class="org-right">-286</td>
</tr>

<tr>
<td class="org-left">Phoenix</td>
<td class="org-left">Heating</td>
<td class="org-right">13.7</td>
<td class="org-right">-1.1</td>
<td class="org-right">-0.7</td>
</tr>

<tr>
<td class="org-left">Phoenix</td>
<td class="org-left">Cooling</td>
<td class="org-right">7992</td>
<td class="org-right">-46</td>
<td class="org-right">-900</td>
</tr>

<tr>
<td class="org-left">Pittsburgh</td>
<td class="org-left">Heating</td>
<td class="org-right">77.6</td>
<td class="org-right">-5.8</td>
<td class="org-right">-2.4</td>
</tr>

<tr>
<td class="org-left">Pittsburgh</td>
<td class="org-left">Cooling</td>
<td class="org-right">1301</td>
<td class="org-right">54</td>
<td class="org-right">-302</td>
</tr>

<tr>
<td class="org-left">Sacramento</td>
<td class="org-left">Heating</td>
<td class="org-right">44.5</td>
<td class="org-right">-4.1</td>
<td class="org-right">-1.5</td>
</tr>

<tr>
<td class="org-left">Sacramento</td>
<td class="org-left">Cooling</td>
<td class="org-right">2756</td>
<td class="org-right">66</td>
<td class="org-right">-441</td>
</tr>

<tr>
<td class="org-left">Washington</td>
<td class="org-left">Heating</td>
<td class="org-right">81.6</td>
<td class="org-right">-11.1</td>
<td class="org-right">-7.6</td>
</tr>

<tr>
<td class="org-left">Washington</td>
<td class="org-left">Cooling</td>
<td class="org-right">3007</td>
<td class="org-right">-8</td>
<td class="org-right">-519</td>
</tr>
</tbody>
</table>


<p>
from /Users/erker/git/energy/RD/EPA<sub>eGrid</sub><sub>powerProfiler</sub>/Power<sub>profiler</sub><sub>zipcode</sub><sub>tool</sub><sub>2016</sub> 5<sub>1</sub><sub>18</sub>.<sub>v8.xlsx</sub>
</p>

<table id="org3bfbfcf" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">City</th>
<th scope="col" class="org-left">Subregion</th>
<th scope="col" class="org-right">EmissionRate<sub>lbCO2mwh</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Chicago</td>
<td class="org-left">RFCW</td>
<td class="org-right">1243.439</td>
</tr>

<tr>
<td class="org-left">Miami</td>
<td class="org-left">FRCC</td>
<td class="org-right">1011.683</td>
</tr>

<tr>
<td class="org-left">Minneapolis</td>
<td class="org-left">MROW</td>
<td class="org-right">1238.817</td>
</tr>

<tr>
<td class="org-left">Phoenix</td>
<td class="org-left">AZNM</td>
<td class="org-right">1043.645</td>
</tr>

<tr>
<td class="org-left">Pittsburgh</td>
<td class="org-left">RFCW</td>
<td class="org-right">1243.439</td>
</tr>

<tr>
<td class="org-left">Sacramento</td>
<td class="org-left">CAMX</td>
<td class="org-right">527.862</td>
</tr>

<tr>
<td class="org-left">Washington</td>
<td class="org-left">RFCE</td>
<td class="org-right">758.178</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">  <span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
  <span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)
  <span style="color: #268bd2; font-weight: bold;">library</span>(ggplot2)
  <span style="color: #268bd2; font-weight: bold;">library</span>(ggthemes)
  <span style="color: #268bd2;">lbCO2mwhTOkgCkwh</span> <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #859900; font-weight: bold;">function</span>(lbmwh) {lbmwh * 0.453592 / 1000 * 12 / 44}

<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">er &lt;- read.csv("../RD/huang_er.csv")</span>
  er <span style="color: #268bd2; font-weight: bold;">&lt;-</span> er <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(kgC_per_kwh = lbCO2mwhTOkgCkwh(EmissionRate_lbCO2mwh))
  er
</pre>
</div>

<pre class="example">
         City Subregion EmissionRate_lbCO2mwh kgC_per_kwh
1     Chicago      RFCW              1243.439  0.15382200
2       Miami      FRCC              1011.683  0.12515218
3 Minneapolis      MROW              1238.817  0.15325022
4     Phoenix      AZNM              1043.645  0.12910610
5  Pittsburgh      RFCW              1243.439  0.15382200
6  Sacramento      CAMX               527.862  0.06530018
7  Washington      RFCE               758.178  0.09379186

</pre>

<pre class="example">
         City Subregion EmissionRate_lbCO2mwh kgC_per_kwh
1     Chicago      RFCW              1243.439  0.15382200
2       Miami      FRCC              1011.683  0.12515218
3 Minneapolis      MROW              1238.817  0.15325022
4     Phoenix      AZNM              1043.645  0.12910610
5  Pittsburgh      RFCW              1243.439  0.15382200
6  Sacramento      CAMX               527.862  0.06530018
7  Washington      RFCE               758.178  0.09379186

</pre>



<p>
They use an old convention where MBtu is Million Btu.  Otherwise it
doesn't make sense.  See here:<a href="https://en.wikipedia.org/wiki/British_thermal_unit#Prefixes">https://en.wikipedia.org/wiki/British_thermal_unit#Prefixes</a>
</p>

<p>
10 therms = 1 MMBtu (million Btus).
</p>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">data &lt;- read.csv("../RD/huang_e_1990_tab6.csv")</span>
                                          <span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">1 US therm = 9.99761000044146 MBtu</span>

  therm_per_mbtu <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 10

  kgC.perThermNaturalGas <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1.446

  data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      mutate(wind = Base + delta_Wind_30pctCvr,
             shade = Base + delta_WindAndShade_30pctCvr - delta_Wind_30pctCvr,
             shade_and_wind = Base + delta_WindAndShade_30pctCvr) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      select(-delta_WindAndShade_30pctCvr, -delta_Wind_30pctCvr) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      gather(condition, energy, -City, -HC, -Base) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      gather(CanopyDensity, energy, -City, -HC, -condition) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      mutate(CanopyDensity = ifelse(CanopyDensity == <span style="color: #2aa198;">"Base"</span>, 0, 30))

  heating <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      filter(HC == <span style="color: #2aa198;">"Heating"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      mutate(kgC = energy * therm_per_mbtu * kgC.perThermNaturalGas)

  cooling <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      filter(HC == <span style="color: #2aa198;">"Cooling"</span>)

  cooling <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(cooling, er) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      mutate(kgC = energy * kgC_per_kwh) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      select(-EmissionRate_lbCO2mwh, -kgC_per_kwh, -Subregion)

  data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(cooling, heating) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      select(-energy)


  data.tot <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      group_by(City, condition, CanopyDensity) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      summarize(kgC = sum(kgC)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      mutate(HC = <span style="color: #2aa198;">"Total"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> data.frame
  data <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(data, data.tot)

</pre>
</div>

<pre class="example">
Joining, by = "City"

</pre>

<p>
shade wind shade wind - line type
</p>

<p>
HC - color
</p>


<div class="figure">
<p><img src="../figs/huang_e_1990_fig4_Carbon.png" alt="huang_e_1990_fig4_Carbon.png" />
</p>
</div>

<p>
Total effect is negative, but if the effect of wind is weaker than we
think,
</p>

<p>
The effect is small:  looking at the heating and cooling effects
combined:
</p>



<div class="figure">
<p><img src="../figs/huang_e_1990_fig4_Carbon_total.png" alt="huang_e_1990_fig4_Carbon_total.png" />
</p>
</div>
<div class="org-src-container">
<pre class="src src-R">data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(HC == <span style="color: #2aa198;">"Total"</span>, condition == <span style="color: #2aa198;">"shade_and_wind"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(CanopyDensity, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgCavoided = <span style="color: #657b83; background-color: #fdf6e3;">`30`</span> - <span style="color: #657b83; background-color: #fdf6e3;">`0`</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(City, condition, kgCavoided)
</pre>
</div>

<pre class="example">
         City      condition kgCavoided
1     Chicago shade_and_wind -229.78787
2       Miami shade_and_wind -173.72472
3 Minneapolis shade_and_wind -129.14356
4     Phoenix shade_and_wind -126.31749
5  Pittsburgh shade_and_wind  -81.15824
6  Sacramento shade_and_wind  -50.48738
7  Washington shade_and_wind -158.57397

</pre>

<p>
I guess chicago really is the windy city&#x2026;
</p>

<p>
Just the shade effect:
</p>
<div class="org-src-container">
<pre class="src src-R">data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(HC == <span style="color: #2aa198;">"Total"</span>, condition == <span style="color: #2aa198;">"shade"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(CanopyDensity, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgCavoided = <span style="color: #657b83; background-color: #fdf6e3;">`30`</span> - <span style="color: #657b83; background-color: #fdf6e3;">`0`</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(City, condition, kgCavoided)
</pre>
</div>

<pre class="example">
         City condition  kgCavoided
1     Chicago     shade   -2.827468
2       Miami     shade -119.131372
3 Minneapolis     shade    3.628930
4     Phoenix     shade -104.472607
5  Pittsburgh     shade   -5.596630
6  Sacramento     shade    4.488811
7  Washington     shade    2.682361

</pre>

<p>
shade estimated to cause an increase in C emissions in Minneapolis,
Sacramento, and Washington.  Kinda surprising.  Very small negative
effects in Pittsburgh and Chicago.  Definitley within uncertainty.
</p>

<p>
Basically, only in Phoenix and Miami is shading really reducing C emissions.
</p>
</div>



<div id="outline-container-org12bd97e" class="outline-4">
<h4 id="org12bd97e"><span class="section-number-4">2.3.1</span> Is the effect of wind stronger on heating than cooling? like <a class='org-ref-reference' href="#simpson_mcpherson_1996">simpson_mcpherson_1996</a> claim?</h4>
<div class="outline-text-4" id="text-2-3-1">
<div class="org-src-container">
<pre class="src src-R">wind <span style="color: #268bd2; font-weight: bold;">&lt;-</span> data <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    filter(condition == <span style="color: #2aa198;">"wind"</span>, HC != <span style="color: #2aa198;">"Total"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    spread(CanopyDensity, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(wind.effect.kgC = <span style="color: #657b83; background-color: #fdf6e3;">`30`</span> - <span style="color: #657b83; background-color: #fdf6e3;">`0`</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    select(City, HC, wind.effect.kgC)

wind

</pre>
</div>

<pre class="example">
          City      HC wind.effect.kgC
1      Chicago Cooling      -1.3843980
2      Chicago Heating    -225.5760000
3        Miami Cooling     -48.8093490
4        Miami Heating      -5.7840000
5  Minneapolis Cooling       4.5975067
6  Minneapolis Heating    -137.3700000
7      Phoenix Cooling      -5.9388805
8      Phoenix Heating     -15.9060000
9   Pittsburgh Cooling       8.3063877
10  Pittsburgh Heating     -83.8680000
11  Sacramento Cooling       4.3098116
12  Sacramento Heating     -59.2860000
13  Washington Cooling      -0.7503349
14  Washington Heating    -160.5060000
</pre>


<div class="figure">
<p><img src="../figs/huang_e_1990_windC.png" alt="huang_e_1990_windC.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb0ccd60" class="outline-3">
<h3 id="orgb0ccd60"><span class="section-number-3">2.4</span> extending <a class='org-ref-reference' href="#mcpherson_simpson_99">mcpherson_simpson_99</a></h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-orgca1e9c5" class="outline-4">
<h4 id="orgca1e9c5"><span class="section-number-4">2.4.1</span> Table 107, shade effects of trees in different regions using default distribution</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
trees increase C emissions net in :
Norther Tier, North Central, mountains, Pacific Northwest, California Coast,
</p>

<p>
1950-1980 vintage, large deciduous tree. shade
difference between cooling and heating
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">northern tier</td>
<td class="org-right">0.0005</td>
</tr>

<tr>
<td class="org-left">north central</td>
<td class="org-right">0.0163</td>
</tr>

<tr>
<td class="org-left">mountains</td>
<td class="org-right">0.0051</td>
</tr>

<tr>
<td class="org-left">Pacific Northwest</td>
<td class="org-right">0.0349</td>
</tr>

<tr>
<td class="org-left">California Coast</td>
<td class="org-right">0.0044</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">nt <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.0373 -0.0378
nc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.0352 - 0.0515
m <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.0503 -0.0554
pnw <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.0033 -0.0382
cc <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 0.0111 -0.0155

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">convert to kg C from tons CO2</span>
c(nt,nc,m,pnw,cc) * 12/44 * 1000
</pre>
</div>

<pre class="example">
[1] -0.1363636 -4.4454545 -1.3909091 -9.5181818 -1.2000000

</pre>
</div>
</div>

<div id="outline-container-orge3a60b0" class="outline-4">
<h4 id="orge3a60b0"><span class="section-number-4">2.4.2</span> Table 109 - climate effects of trees, (evapotranspiration and wind)</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
0.21312
</p>

<p>
Region | existing cover | effect (t CO2/tree)
</p>
<table id="org31a47d3" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Region</th>
<th scope="col" class="org-right">existing cover</th>
<th scope="col" class="org-right">effect</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">nt</td>
<td class="org-right">10</td>
<td class="org-right">0.21312</td>
</tr>

<tr>
<td class="org-left">nt</td>
<td class="org-right">60</td>
<td class="org-right">0.02416</td>
</tr>

<tr>
<td class="org-left">nc</td>
<td class="org-right">10</td>
<td class="org-right">0.24252</td>
</tr>

<tr>
<td class="org-left">nc</td>
<td class="org-right">60</td>
<td class="org-right">0.03392</td>
</tr>

<tr>
<td class="org-left">m</td>
<td class="org-right">10</td>
<td class="org-right">0.14432</td>
</tr>

<tr>
<td class="org-left">m</td>
<td class="org-right">60</td>
<td class="org-right">0.01528</td>
</tr>

<tr>
<td class="org-left">pnw</td>
<td class="org-right">10</td>
<td class="org-right">0.10531</td>
</tr>

<tr>
<td class="org-left">pnw</td>
<td class="org-right">60</td>
<td class="org-right">0.00927</td>
</tr>

<tr>
<td class="org-left">cc</td>
<td class="org-right">10</td>
<td class="org-right">0.04350</td>
</tr>

<tr>
<td class="org-left">cc</td>
<td class="org-right">60</td>
<td class="org-right">0.00454</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
<span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)
d <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(kgc = effect * 12/44 * 1000)
</pre>
</div>

<pre class="example">
   Region existing.cover  effect       kgc
1      nt             10 0.21312 58.123636
2      nt             60 0.02416  6.589091
3      nc             10 0.24252 66.141818
4      nc             60 0.03392  9.250909
5       m             10 0.14432 39.360000
6       m             60 0.01528  4.167273
7     pnw             10 0.10531 28.720909
8     pnw             60 0.00927  2.528182
9      cc             10 0.04350 11.863636
10     cc             60 0.00454  1.238182
</pre>
</div>
</div>
</div>

<div id="outline-container-org8d6f60f" class="outline-3">
<h3 id="org8d6f60f"><span class="section-number-3">2.5</span> extending <a class='org-ref-reference' href="#akbari_konopacki_2003">akbari_konopacki_2003</a>,<a class='org-ref-reference' href="#akbari_konopacki_2005">akbari_konopacki_2005</a></h3>
<div class="outline-text-3" id="text-2-5">
<p>
Use their data (along with their less than awesome assumptions and
interpolation, see figures with poor fit), to
</p>

<ol class="org-ol">
<li>plot where in the US trees are C sinks and where they are C sources according to their assumptions.</li>
<li>show what percent of the U.S. population lives where trees are C sources/sinks.</li>
</ol>

<p>
they add 4 shade trees in the residential case
</p>

<p>
my beef with their methods:
</p>
<ul class="org-ul">
<li>indirect effects combines albedo increase with veg cover increase.
impossible to separate out the veg effect frmo their methods</li>
<li>they assume trees transmit 90% of light in winter, it should be more
like 70%.</li>
<li>they assume a HUGE number of trees are planted (not sure if there is
space for all these).</li>
<li>They position trees to west an south of buildings.  Given the 90%
transmissivity this isn't so much a detrimint in winter, but it's
certainly optimistic in summer.</li>
<li>I can't figure out how they model ET;  if they follow
<a class='org-ref-reference' href="#huang_e_1987">huang_e_1987</a> it's definitely optimistic.</li>
<li>wind is ignored (not sure what this means for winter, maybe the
heating penalties aren't as high?)</li>
<li>they recognize that regarding indirect savings, their estimates is
an upper boundary: "It is important to notice that in all our
previous calculationsweassumedthatallurbansurfaceswould be modified
to the levels discussed above. This provided an upper boundary for
estimates of indirect saving potentials."</li>
<li>"In very cold climates, the energy-savings potentials of HIR are
expected to be minimal." in fact they are negative. HIR (heat island reduction)</li>
</ul>


<p>
#+END<sub>QUOTE</sub>
</p>

<blockquote>
<p>
In climates with less than 1000 cooling-degree-days, the electricity
savings were not significantly higher than winter heating penalties.
</p>
</blockquote>
</div>

<div id="outline-container-org1b37049" class="outline-4">
<h4 id="org1b37049"><span class="section-number-4">2.5.1</span> data needed</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
census tract centroids with HDD &amp; CDD
subregion shapefile
subregion emission factors
</p>

<p>
download census tract shapefile (not centroids) <span class="timestamp-wrapper"><span class="timestamp">[2018-07-26 Thu]</span></span>
<a href="https://www2.census.gov/geo/tiger/GENZ2017/shp/">https://www2.census.gov/geo/tiger/GENZ2017/shp/</a>
</p>

<div class="org-src-container">
<pre class="src src-R">i <span style="color: #268bd2; font-weight: bold;">&lt;-</span> sprintf(<span style="color: #2aa198;">"%02d"</span>, 1:78)
files <span style="color: #268bd2; font-weight: bold;">&lt;-</span> paste0(<span style="color: #2aa198;">"cb_2017_"</span>,i,<span style="color: #2aa198;">"_tract_500k.zip"</span>)

lapply(files, <span style="color: #859900; font-weight: bold;">function</span>(file) {
    url <span style="color: #268bd2; font-weight: bold;">&lt;-</span> paste0(<span style="color: #2aa198;">"https://www2.census.gov/geo/tiger/GENZ2017/shp/"</span>,file)
    destination <span style="color: #268bd2; font-weight: bold;">&lt;-</span> paste0(<span style="color: #2aa198;">"~/git/energy/papers/data/census_tracts/"</span>,file)
    tryCatch(download.file(url, destination, method = <span style="color: #2aa198;">"libcurl"</span>), error=<span style="color: #859900; font-weight: bold;">function</span>(e) <span style="color: #b58900;">NULL</span>)
    Sys.sleep(2)
})
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">fs <span style="color: #268bd2; font-weight: bold;">&lt;-</span> list.files(<span style="color: #2aa198;">"~/git/energy/papers/data/census_tracts/"</span>, pattern = <span style="color: #2aa198;">".*.shp$"</span>, recursive = T, full.names = T)
tracts <span style="color: #268bd2; font-weight: bold;">&lt;-</span> lapply(fs, <span style="color: #859900; font-weight: bold;">function</span>(f) shapefile(f))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ustracts <span style="color: #268bd2; font-weight: bold;">&lt;-</span> do.call(<span style="color: #2aa198;">"rbind"</span>, tracts)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">ustracts.area <span style="color: #268bd2; font-weight: bold;">&lt;-</span> select(ustracts@data, GEOID, ALAND) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> rename(FIPS = GEOID) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(ALAND = as.numeric(ALAND), FIPS = as.numeric(FIPS))
</pre>
</div>

<p>
downloaded <span class="timestamp-wrapper"><span class="timestamp">[2018-07-11 Wed]</span></span>
</p>
<div class="org-src-container">
<pre class="src src-sh">wget -O ~/git/energy/papers/data/tracts_wHDDCDD.csv https://raw.githubusercontent.com/TedwardErker/us_energy_climate_population/master/data/census_climate/tracts_wHDDCDD.csv
</pre>
</div>

<p>
from :
/Users/erker/git/energy/RD/EPA<sub>eGrid</sub><sub>powerProfiler</sub>/egrid2016<sub>data</sub><sub>metric.xlsx</sub>
</p>

<table id="org709b7f6" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">eGRID subregion acronym</td>
<td class="org-left">eGRID subregion name</td>
<td class="org-left">eGRID subregion annual CO2 total output emission rate (kg/MWh)</td>
</tr>
</tbody>
</table>


<table id="org778cd4d" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">SUBRGN</th>
<th scope="col" class="org-left">SRNAME</th>
<th scope="col" class="org-right">SRCO2RTA</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AKGD</td>
<td class="org-left">ASCC Alaska Grid</td>
<td class="org-right">486.383</td>
</tr>

<tr>
<td class="org-left">AKMS</td>
<td class="org-left">ASCC Miscellaneous</td>
<td class="org-right">228.216</td>
</tr>

<tr>
<td class="org-left">AZNM</td>
<td class="org-left">WECC Southwest</td>
<td class="org-right">473.394</td>
</tr>

<tr>
<td class="org-left">CAMX</td>
<td class="org-left">WECC California</td>
<td class="org-right">239.437</td>
</tr>

<tr>
<td class="org-left">ERCT</td>
<td class="org-left">ERCOT All</td>
<td class="org-right">457.750</td>
</tr>

<tr>
<td class="org-left">FRCC</td>
<td class="org-left">FRCC All</td>
<td class="org-right">458.896</td>
</tr>

<tr>
<td class="org-left">HIMS</td>
<td class="org-left">HICC Miscellaneous</td>
<td class="org-right">522.551</td>
</tr>

<tr>
<td class="org-left">HIOA</td>
<td class="org-left">HICC Oahu</td>
<td class="org-right">754.281</td>
</tr>

<tr>
<td class="org-left">MROE</td>
<td class="org-left">MRO East</td>
<td class="org-right">756.696</td>
</tr>

<tr>
<td class="org-left">MROW</td>
<td class="org-left">MRO West</td>
<td class="org-right">561.924</td>
</tr>

<tr>
<td class="org-left">NEWE</td>
<td class="org-left">NPCC New England</td>
<td class="org-right">253.178</td>
</tr>

<tr>
<td class="org-left">NWPP</td>
<td class="org-left">WECC Northwest</td>
<td class="org-right">295.382</td>
</tr>

<tr>
<td class="org-left">NYCW</td>
<td class="org-left">NPCC NYC/Westchester</td>
<td class="org-right">288.402</td>
</tr>

<tr>
<td class="org-left">NYLI</td>
<td class="org-left">NPCC Long Island</td>
<td class="org-right">534.483</td>
</tr>

<tr>
<td class="org-left">NYUP</td>
<td class="org-left">NPCC Upstate NY</td>
<td class="org-right">133.657</td>
</tr>

<tr>
<td class="org-left">RFCE</td>
<td class="org-left">RFC East</td>
<td class="org-right">343.907</td>
</tr>

<tr>
<td class="org-left">RFCM</td>
<td class="org-left">RFC Michigan</td>
<td class="org-right">576.996</td>
</tr>

<tr>
<td class="org-left">RFCW</td>
<td class="org-left">RFC West</td>
<td class="org-right">564.020</td>
</tr>

<tr>
<td class="org-left">RMPA</td>
<td class="org-left">WECC Rockies</td>
<td class="org-right">620.415</td>
</tr>

<tr>
<td class="org-left">SPNO</td>
<td class="org-left">SPP North</td>
<td class="org-right">640.638</td>
</tr>

<tr>
<td class="org-left">SPSO</td>
<td class="org-left">SPP South</td>
<td class="org-right">566.238</td>
</tr>

<tr>
<td class="org-left">SRMV</td>
<td class="org-left">SERC Mississippi Valley</td>
<td class="org-right">380.518</td>
</tr>

<tr>
<td class="org-left">SRMW</td>
<td class="org-left">SERC Midwest</td>
<td class="org-right">731.466</td>
</tr>

<tr>
<td class="org-left">SRSO</td>
<td class="org-left">SERC South</td>
<td class="org-right">494.137</td>
</tr>

<tr>
<td class="org-left">SRTV</td>
<td class="org-left">SERC Tennessee Valley</td>
<td class="org-right">537.709</td>
</tr>

<tr>
<td class="org-left">SRVC</td>
<td class="org-left">SERC Virginia/Carolina</td>
<td class="org-right">365.275</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">library</span>(raster)
tracts <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">"../papers/data/tracts_wHDDCDD.csv"</span>, header = T)
tracts.df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> tracts
coordinates(tracts) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> ~LONGITUDE +LATITUDE

subregions <span style="color: #268bd2; font-weight: bold;">&lt;-</span> shapefile(<span style="color: #2aa198;">"/Users/erker/git/energy/RD/EPA_eGrid_powerProfiler/eGRID 2016 Subregions_shapefiles/eGRID2016 Subregions.shp"</span>)
proj4string(tracts) <span style="color: #268bd2; font-weight: bold;">&lt;-</span> proj4string(subregions)
</pre>
</div>

<pre class="example">
+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0

</pre>

<div class="org-src-container">
<pre class="src src-R">d <span style="color: #268bd2; font-weight: bold;">&lt;-</span>over(tracts, subregions, df = T)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cbind(tracts.df, d)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">df <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(df, ustracts.area)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R"><span style="color: #93a1a1;">#  </span><span style="color: #93a1a1;">ef &lt;- read.csv("/Users/erker/git/energy/code/eGrid_2016_CO2_emissionFactors.csv")</span>
  <span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
  def <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(df, ef, by = c(<span style="color: #2aa198;">"Subregions"</span> = <span style="color: #2aa198;">"SUBRGN"</span>))
</pre>
</div>

<p>
data from <a class='org-ref-reference' href="#akbari_konopacki_2005">akbari_konopacki_2005</a>
Table 6: energy use, HDD
Table 7: energy use, CDD
Table 8: Carbon, HDD.
Table 9: Carbon, CDD.
</p>

<p>
In table 8, they do give C effect, but they assume:
#+BEGIN<sub>QUOTE</sub>
Togeneratethesetablesweuseddataprovided by DOE’s office of Energy
Information Administration (EIA, 1997). (The corresponding conversion
factor for 2001 is 0.173kgC/kWh (EIA, 2003).) In 1995, the US mix of
electricity generation emitted 0.167
kgC/kWh. Theestimatedcarbonemissionfromcombustionof natural gas was
1.447 kgC/therm.
</p>

<p>
I look at pre 1980 houses, because I think this is most houses.  the difference is in maginitidue, not direction
between pre and post 1980 houses.  And a house with gas heat.
</p>

<p>
elec units are kWh/1000ft<sup>2</sup>;  gas units are Therm/1000ft<sup>2</sup>
savings have a negative effect. (unlike in their table)
</p>

<p>
note that indirect include evapo trans from trees and albedo effects
</p>


<table id="org9c7a73f" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">bin</th>
<th scope="col" class="org-right">hddmin</th>
<th scope="col" class="org-right">hddmax</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">500</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">500</td>
<td class="org-right">1000</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1000</td>
<td class="org-right">1500</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">1500</td>
<td class="org-right">2000</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">2000</td>
<td class="org-right">2500</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">2500</td>
<td class="org-right">3000</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">3000</td>
<td class="org-right">3500</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-right">3500</td>
<td class="org-right">4000</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-right">4000</td>
<td class="org-right">4500</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-right">4500</td>
<td class="org-right">5000</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-right">5000</td>
<td class="org-right">5500</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-right">5500</td>
<td class="org-right">6000</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-right">6000</td>
<td class="org-right">7000</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-right">7000</td>
<td class="org-right">8000</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-right">8000</td>
<td class="org-right">&#xa0;</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-R">def <span style="color: #268bd2; font-weight: bold;">&lt;-</span> mutate(def, bin = ifelse(hdd &lt; 500, 1,
                         ifelse(hdd &lt; 1000, 2,
                         ifelse(hdd &lt; 1500, 3,
                         ifelse(hdd &lt; 2000, 4,
                         ifelse(hdd &lt; 2500, 5,
                         ifelse(hdd &lt; 3000, 6,
                         ifelse(hdd &lt; 3500, 7,
                         ifelse(hdd &lt; 4000, 8,
                         ifelse(hdd &lt; 4500, 9,
                         ifelse(hdd &lt; 5000, 10,
                         ifelse(hdd &lt; 5500, 11,
                         ifelse(hdd &lt; 6000, 12,
                         ifelse(hdd &lt; 6500, 13,
                         ifelse(hdd &lt; 7000, 14, 15)))))))))))))))

</pre>
</div>

<p>
from table 6
</p>
<table id="org42aa79e" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">bin</th>
<th scope="col" class="org-left">effect</th>
<th scope="col" class="org-left">energy</th>
<th scope="col" class="org-right">value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-298</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-216</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-291</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-173</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-249</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-146</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-293</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-175</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-307</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-168</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-282</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-157</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">12</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-211</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-114</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">16</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-250</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-131</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">14</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-223</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-119</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">7</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-181</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-88</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">29</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">11</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-183</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-88</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">24</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">10</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-185</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-85</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">19</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-190</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-81</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">15</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">8</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-168</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-67</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">17</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">9</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">shade</td>
<td class="org-left">elec</td>
<td class="org-right">-82</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">indirect</td>
<td class="org-left">elec</td>
<td class="org-right">-31</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">shade</td>
<td class="org-left">gas</td>
<td class="org-right">22</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">indirect</td>
<td class="org-left">gas</td>
<td class="org-right">11</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-R"><span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">tab6 &lt;- read.csv("/Users/erker/git/energy/code/akbari_konopacki_2005_tab6.csv")</span>
  defe <span style="color: #268bd2; font-weight: bold;">&lt;-</span> left_join(def, tab6)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">kgC.perThermNaturalGas <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 1.446

CperCO2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> 12/44

heating <span style="color: #268bd2; font-weight: bold;">&lt;-</span> defe <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(energy == <span style="color: #2aa198;">"gas"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = kgC.perThermNaturalGas * value)

cooling <span style="color: #268bd2; font-weight: bold;">&lt;-</span> defe <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> filter(energy == <span style="color: #2aa198;">"elec"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC = value / 1000 * SRCO2RTA * CperCO2 )

defC <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(heating, cooling)

</pre>
</div>


<div class="figure">
<p><img src="../figs/akbari_konopacki_2005_SRCO2RTA.png" alt="akbari_konopacki_2005_SRCO2RTA.png" />
</p>
</div>



<div class="figure">
<p><img src="../figs/akbari_konopacki_2005_elecC.png" alt="akbari_konopacki_2005_elecC.png" />
</p>
</div>



<div class="figure">
<p><img src="../figs/akbari_konopacki_2005_gasC.png" alt="akbari_konopacki_2005_gasC.png" />
</p>
</div>




<div class="org-src-container">
<pre class="src src-R"><span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)
defC <span style="color: #268bd2; font-weight: bold;">&lt;-</span> defC <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> select(-value) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> spread(energy, kgC) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    mutate(kgC.net = elec + gas)

</pre>
</div>

<p>
Area of tracts
</p>

<div class="figure">
<p><img src="../figs/Tract_AreaLand.png" alt="Tract_AreaLand.png" />
</p>
</div>


<p>
NET SHADE EFFECT:
</p>


<div class="figure">
<p><img src="../figs/akbari_konopacki_2005_shade_netkgC.png" alt="akbari_konopacki_2005_shade_netkgC.png" />
</p>
</div>


<p>
indirect effect
</p>

<div class="figure">
<p><img src="../figs/akbari_konopacki_2005_indirect_netkgC.png" alt="akbari_konopacki_2005_indirect_netkgC.png" />
</p>
</div>

<p>
<img src="../figs/akbari_konopacki_2005_netkgC_shade_v_indirect.png" alt="akbari_konopacki_2005_netkgC_shade_v_indirect.png" />
the relationship between indirect and shade is pretty constant across
regions.  So a plot of total effect shows same pattern as shade and
indirect separately.
</p>


<div class="org-src-container">
<pre class="src src-R">      <span style="color: #268bd2; font-weight: bold;">library</span>(mapproj)

      defC.sum <span style="color: #268bd2; font-weight: bold;">&lt;-</span> defC <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
                select(-elec, -gas) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
                spread(effect, kgC.net)  <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
          mutate(kgC.total.tree.effect = shade + indirect) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
          rename(lat = LATITUDE, long = LONGITUDE)

      defC.sum.f <span style="color: #268bd2; font-weight: bold;">&lt;-</span> defC.sum <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
                filter(long &lt; 0, lat &lt; 50,  lat &gt; 25)

      tract.cds <span style="color: #268bd2; font-weight: bold;">&lt;-</span> select(defC.sum.f, lat, long) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
          mutate(data = <span style="color: #2aa198;">"tracts"</span>)

      cities <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">"../RD/cities_hdd_cdd.csv"</span>, stringsAsFactors = F) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
          rename(lat = latitude, long = longitude) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
          filter(long &lt; 0, lat &lt; 50,  lat &gt; 25)

cities$city[cities$city == <span style="color: #2aa198;">"Louisville/Jefferson County"</span>] <span style="color: #268bd2; font-weight: bold;">&lt;-</span> <span style="color: #2aa198;">"Louisville"</span>

      cities.cds <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cities <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> select(long,lat) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
              mutate(data = <span style="color: #2aa198;">"cities"</span>)


      cds <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(cities.cds, tract.cds)

      cdsp <span style="color: #268bd2; font-weight: bold;">&lt;-</span> mapproject(cds$long,cds$lat,projection =<span style="color: #2aa198;">"albers"</span>, par=c(29.5,45.5))[c(<span style="color: #2aa198;">"x"</span>,<span style="color: #2aa198;">"y"</span>)] <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
          data.frame <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
        mutate(data = cds$data)

      defC.sum.f$x <span style="color: #268bd2; font-weight: bold;">&lt;-</span> filter(cdsp, data == <span style="color: #2aa198;">"tracts"</span>)$x
      defC.sum.f$y <span style="color: #268bd2; font-weight: bold;">&lt;-</span> filter(cdsp, data == <span style="color: #2aa198;">"tracts"</span>)$y

      cities$x <span style="color: #268bd2; font-weight: bold;">&lt;-</span> filter(cdsp, data == <span style="color: #2aa198;">"cities"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> pull(x)
      cities$y <span style="color: #268bd2; font-weight: bold;">&lt;-</span> filter(cdsp, data == <span style="color: #2aa198;">"cities"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> pull(y)


    madison <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cities <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      filter(population == 243344 &amp; city == <span style="color: #2aa198;">"Madison"</span>)

  cities.exclude <span style="color: #268bd2; font-weight: bold;">&lt;-</span> c(<span style="color: #2aa198;">"Milwaukee"</span>, <span style="color: #2aa198;">"San Jose"</span>, <span style="color: #2aa198;">"Long Beach"</span>, <span style="color: #2aa198;">"Oakland"</span>, <span style="color: #2aa198;">"Baltimore"</span>, <span style="color: #2aa198;">"Fort Worth"</span>, <span style="color: #2aa198;">"Mesa"</span>)

    cities <span style="color: #268bd2; font-weight: bold;">&lt;-</span> cities <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
          filter(population &gt; 379577 &amp; !city <span style="color: #268bd2; font-weight: bold;">%in%</span> cities.exclude)

        p <span style="color: #268bd2; font-weight: bold;">&lt;-</span>        ggplot(defC.sum.f, aes(x = x, y = y)) +
            geom_point(alpha = .2, aes(color = kgC.total.tree.effect)) +
            geom_point(data = cities) +
            geom_point(data = madison, size = 4) +
            geom_text(data = cities, aes(label = city),check_overlap = F, vjust = 0, nudge_y = 0.005) +
            geom_text(data = madison, aes(label = city),size = 8, vjust = 0, nudge_y = 0.007) +
                    coord_equal() +
                    scale_color_gradient2(low = <span style="color: #2aa198;">"#4dac26"</span>, mid = <span style="color: #2aa198;">"#f7f7f7"</span>, high = <span style="color: #2aa198;">"#d01c8b"</span>, name = <span style="color: #2aa198;">"Tree Effect (kg C)"</span>,
                                          guide = guide_legend(
                                              direction = <span style="color: #2aa198;">"horizontal"</span>,
                                              title.position = <span style="color: #2aa198;">"top"</span>,
                                              nrow = 1,
                                              override.aes = list(alpha = 1, size = 4),
                                              label.position = <span style="color: #2aa198;">"bottom"</span>)
                                              <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">label.hjust = 0.5,</span>
                                              <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">label.vjust = 1,</span>
                                              <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">label.theme = element_text(angle = 90)</span>
                                          ) +
                    theme_void() +
                    theme(legend.position = c(.25,.15),
                          text = element_text(size = 18))

</pre>
</div>


<div class="figure">
<p><img src="../figs/akbari_konopacki_2005_netkgC_wCities.png" alt="akbari_konopacki_2005_netkgC_wCities.png" />
</p>
</div>

<p>
Net effect of Shade trees (direct effect and indirect effect) on C
emissions from building energy use for 1000ft<sup>2</sup> of roof area in a
residential house.  caveat: indirect effect also includes increased.
albedo effect
</p>

<p>
I don't buy their results exactly, for the reasons I was saying things
were so uncertain, but it notable that even with their assumptions, if
applied to the US in this way it shows
</p>

<div class="org-src-container">
<pre class="src src-R">defC.sum <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(trees_good = kgC.total.tree.effect &lt; 0) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(trees_good) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
  summarize(pop = sum(POPULATION),
            pop.pct = pop/ sum(.$POPULATION)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
  data.frame()
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">FALSE</td>
<td class="org-right">123148731</td>
<td class="org-right">0.394112100404016</td>
</tr>

<tr>
<td class="org-left">TRUE</td>
<td class="org-right">185296900</td>
<td class="org-right">0.593004490296801</td>
</tr>

<tr>
<td class="org-left">nil</td>
<td class="org-right">4025696</td>
<td class="org-right">0.0128834092991835</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-R">defC.sum <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(trees_good = kgC.total.tree.effect &lt; 0) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
    group_by(trees_good) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
  summarize(ALAND = sum(ALAND,na.rm = T),
           ALAND.pct = ALAND / sum(.$ALAND, na.rm = T)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
  data.frame()
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">FALSE</td>
<td class="org-right">5616464227894</td>
<td class="org-right">0.618974755366065</td>
</tr>

<tr>
<td class="org-left">TRUE</td>
<td class="org-right">3348957343184</td>
<td class="org-right">0.369079187210631</td>
</tr>

<tr>
<td class="org-left">nil</td>
<td class="org-right">108396349933</td>
<td class="org-right">0.0119460574233037</td>
</tr>
</tbody>
</table>


<p>
exclude alaska
</p>
<div class="org-src-container">
<pre class="src src-R">    defC.sum <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      filter(lat &lt; 50) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
mutate(trees_good = kgC.total.tree.effect &lt; 0) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
        group_by(trees_good) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      summarize(ALAND = sum(ALAND,na.rm = T),
               ALAND.pct = ALAND / sum(.$ALAND, na.rm = T)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      data.frame()
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-left">FALSE</td>
<td class="org-right">4277379985538</td>
<td class="org-right">0.559906938810506</td>
</tr>

<tr>
<td class="org-left">TRUE</td>
<td class="org-right">3348957343184</td>
<td class="org-right">0.438376871021262</td>
</tr>

<tr>
<td class="org-left">nil</td>
<td class="org-right">13110745676</td>
<td class="org-right">0.0017161901682319</td>
</tr>
</tbody>
</table>




<div class="org-src-container">
<pre class="src src-R">      <span style="color: #268bd2; font-weight: bold;">library</span>(plotly)
    <span style="color: #268bd2; font-weight: bold;">library</span>(htmlwidgets)

pw <span style="color: #268bd2; font-weight: bold;">&lt;-</span> ggplotly(p)
saveWidget(pw, <span style="color: #2aa198;">"akbari_konopacki_2005_netC.html"</span>, selfcontained = F)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-R">getwd()
</pre>
</div>

<pre class="example">
/Users/erker/git/energy/code

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org12c78aa" class="outline-2">
<h2 id="org12c78aa"><span class="section-number-2">3</span> compare 2015-04 &#x2013;2016-04 to climate normals</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-R">      <span style="color: #268bd2; font-weight: bold;">library</span>(ggplot2)
        <span style="color: #268bd2; font-weight: bold;">library</span>(dplyr)
        <span style="color: #268bd2; font-weight: bold;">library</span>(tidyr)
        <span style="color: #268bd2; font-weight: bold;">library</span>(lubridate)

        weather <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">"/Users/erker/git/energy/RD/MadisonWeatherClimate/MadisonWeather_201504-201604.csv"</span>) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            select(DATE, AWND, PRCP, SNOW, TAVG, TMAX, TMIN, WDF2, WSF2) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            gather(var, value, -DATE) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            rename(date = DATE) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            mutate(date = ymd(date))

    temp_weat <span style="color: #268bd2; font-weight: bold;">&lt;-</span> weather <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      filter(grepl(<span style="color: #2aa198;">"^T.*"</span>, var)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
      rename(temp = value)

prcp_weat <span style="color: #268bd2; font-weight: bold;">&lt;-</span> weather <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
  filter(var == <span style="color: #2aa198;">"PRCP"</span>)

        climate <span style="color: #268bd2; font-weight: bold;">&lt;-</span> read.csv(<span style="color: #2aa198;">"/Users/erker/git/energy/RD/MadisonWeatherClimate/MadisonClimate_1981-2010.csv"</span>)  <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            select(DATE,
                   DLY.PRCP.25PCTL,
                   DLY.SNOW.25PCTL,
                   DLY.PRCP.50PCTL,
                   DLY.SNOW.50PCTL,
                   DLY.PRCP.75PCTL,
                   DLY.SNOW.75PCTL,
                   DLY.TAVG.NORMAL,
                   DLY.DUTR.NORMAL,
                   DLY.TMAX.NORMAL,
                   DLY.TMIN.NORMAL,
                   DLY.TAVG.STDDEV,
                   DLY.DUTR.STDDEV,
                   DLY.TMAX.STDDEV,
                   DLY.TMIN.STDDEV) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            gather(variable, value, -DATE) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            separate(variable, c(<span style="color: #2aa198;">"freq"</span>, <span style="color: #2aa198;">"var"</span>, <span style="color: #2aa198;">"stat"</span>)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            rename(date = DATE) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
            mutate(date = ymd(date))

    climate1 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> climate <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(date = date + years(5))
    climate2 <span style="color: #268bd2; font-weight: bold;">&lt;-</span> climate <span style="color: #268bd2; font-weight: bold;">%&gt;%</span> mutate(date = date + years(6))
  climate <span style="color: #268bd2; font-weight: bold;">&lt;-</span> rbind(climate1, climate2)

      temp_clim <span style="color: #268bd2; font-weight: bold;">&lt;-</span> filter(climate, grepl(<span style="color: #2aa198;">"^T.*"</span>, var)) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
        spread(stat, value) <span style="color: #268bd2; font-weight: bold;">%&gt;%</span>
        rename(temp = NORMAL, sd = STDDEV)

  prcp_clim <span style="color: #268bd2; font-weight: bold;">&lt;-</span> filter(climate, var == <span style="color: #2aa198;">"PRCP"</span>)

        str(prcp_clim)

</pre>
</div>

<pre class="example">
'data.frame':	2190 obs. of  5 variables:
 $ date : Date, format: "2015-01-01" "2015-01-02" ...
 $ freq : chr  "DLY" "DLY" "DLY" "DLY" ...
 $ var  : chr  "PRCP" "PRCP" "PRCP" "PRCP" ...
 $ stat : chr  "25PCTL" "25PCTL" "25PCTL" "25PCTL" ...
 $ value: num  0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 0.05 ...

</pre>


<div class="figure">
<p><img src="../figs/Madison_Temp_Climate.png" alt="Madison_Temp_Climate.png" />
</p>
</div>



<div class="figure">
<p><img src="../figs/Madison_Precip.png" alt="Madison_Precip.png" />
</p>
</div>


<div class="figure">
<p><img src="../figs/Madison_Precip_log.png" alt="Madison_Precip_log.png" />
</p>
</div>

<p>
The blue geom<sub>quantile</sub> line is the 75th quantile of precip during
study time.  It matches pretty well with the 75th percentile of
climate normals.  The other percentiles don't match up too well
though.  I think the zero inflation is a problem.  I should probably
look at a cumulative distribution instead.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Tedward Erker</p>
<p class="date">Created: 2018-09-24 Mon 13:36</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
